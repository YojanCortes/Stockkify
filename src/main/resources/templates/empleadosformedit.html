<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title th:text="${form.rut != null ? 'Editar empleado' : 'Nuevo empleado'}">Empleado</title>

    <!-- CSRF para AJAX -->
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">

    <link th:href="@{/vendor/fontawesome-free/css/all.min.css}" rel="stylesheet"/>
    <link th:href="@{/css/sb-admin-2.min.css}" rel="stylesheet"/>
    <style>
        .modal-header-success { background:#28a745; color:#fff; }
        .modal-header-error   { background:#dc3545; color:#fff; }
        .btn-icon { display:inline-flex; align-items:center; }
        .btn-icon i { margin-right:.4rem; }

        /* Foto */
        .foto-wrap { display:flex; align-items:center; }
        .foto-preview, .foto-actual {
            width:110px; height:110px; border-radius:50%;
            object-fit:cover; box-shadow:0 0.5rem 1rem rgba(0,0,0,.15);
        }
        .avatar-placeholder {
            width:110px; height:110px; border-radius:50%;
            background:#f8f9fc; border:2px dashed #d1d3e2; color:#858796;
            font-weight:600; display:flex; align-items:center; justify-content:center;
        }
        .text-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    </style>
</head>
<body id="page-top">
<div id="wrapper">
    <!-- Sidebar -->
    <div th:replace="~{menugeneral :: sidebar}"></div>

    <div id="content-wrapper" class="d-flex flex-column">
        <div id="content">
            <!-- Topbar -->
            <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
                <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
                    <i class="fa fa-bars"></i>
                </button>
                <span class="navbar-text font-weight-bold"
                      th:text="${form.rut != null ? 'Editar empleado' : 'Nuevo empleado'}">Empleado</span>
                <ul class="navbar-nav ml-auto"></ul>
            </nav>

            <div class="container-fluid">
                <div class="d-sm-flex align-items-center justify-content-between mb-3">
                    <h1 class="h3 mb-0 text-gray-800"
                        th:text="${form.rut != null ? 'Editar empleado' : 'Nuevo empleado'}">Empleado</h1>
                    <div>
                        <a class="btn btn-secondary btn-sm mr-2" th:href="@{/empleados}">
                            <i class="fas fa-list mr-1"></i> Volver a la lista
                        </a>
                        <!-- Botón eliminar solo en edición -->
                        <button type="button" class="btn btn-danger btn-sm" id="btnEliminar"
                                th:if="${form.rut != null}">
                            <i class="fas fa-user-times mr-1"></i> Eliminar
                        </button>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-12">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3 d-flex align-items-center">
                                <i class="fas fa-user-edit mr-2 text-primary"></i>
                                <h6 class="m-0 font-weight-bold text-primary"
                                    th:text="${form.rut != null ? 'Editar datos del empleado' : 'Nuevo empleado'}">Formulario</h6>
                            </div>
                            <div class="card-body">
                                <!-- FORM -->
                                <form id="empleadoForm"
                                      th:with="rutVal=${form.rut},
                               actionUrl=${rutVal != null ? '/empleados/' + rutVal : '/empleados'}"
                                      th:attr="data-action-url=${actionUrl}"
                                      th:object="${form}" method="post">

                                    <!-- CSRF fallback -->
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                                    <!-- RUT + Foto -->
                                    <div class="form-row">
                                        <!-- RUT -->
                                        <div class="form-group col-md-6">
                                            <label for="rut">RUT</label>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text"><i class="far fa-id-card"></i></span>
                                                </div>
                                                <input id="rut" type="text" class="form-control" placeholder="12.345.678-9"
                                                       th:field="*{rut}">
                                            </div>
                                            <small class="text-muted">Se normaliza a <span class="text-mono">########-X</span>.</small>
                                            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('rut')}" th:errors="*{rut}">Error</div>
                                        </div>

                                        <!-- FOTO (ver actual + seleccionar nueva) -->
                                        <div class="form-group col-md-6">
                                            <label for="foto">Foto del empleado (opcional)</label>
                                            <div class="foto-wrap">
                                                <!-- Actual -->
                                                <div class="mr-3">
                                                    <!-- Placeholder por defecto -->
                                                    <div id="currentFotoPH" class="avatar-placeholder">Sin&nbsp;imagen</div>
                                                    <!-- Intento de cargar actual -->
                                                    <img id="currentFoto" class="foto-actual d-none"
                                                         th:if="${form.rut != null}"
                                                         th:src="@{'/empleados/' + ${form.rut} + '/foto?v=' + ${#dates.format(#dates.createNow(), 'yyyyMMddHHmmss')}}"
                                                         alt="Foto actual"
                                                         onload="this.classList.remove('d-none');document.getElementById('currentFotoPH').classList.add('d-none');"
                                                         onerror="this.classList.add('d-none');document.getElementById('currentFotoPH').classList.remove('d-none');">
                                                </div>

                                                <!-- Nueva -->
                                                <div>
                                                    <input id="foto" name="foto" type="file" accept="image/*" class="d-none">
                                                    <div class="btn-group mb-1">
                                                        <button type="button" id="btnSelectFoto" class="btn btn-outline-primary btn-sm btn-icon">
                                                            <i class="fas fa-image"></i> Seleccionar imagen
                                                        </button>
                                                        <button type="button" id="btnClearFoto" class="btn btn-outline-secondary btn-sm btn-icon d-none">
                                                            <i class="fas fa-times"></i> Quitar
                                                        </button>
                                                    </div>
                                                    <!-- Preview de nueva selección -->
                                                    <div class="mt-1">
                                                        <img id="fotoPreview" class="foto-preview d-none" alt="Vista previa"/>
                                                    </div>
                                                    <div id="fotoMeta" class="small text-muted mt-1">JPG/PNG/WebP. Máx 2&nbsp;MB.</div>
                                                    <div id="fotoError" class="small text-danger d-none"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Nombre + Email -->
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="nombre">Nombre completo</label>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                                                </div>
                                                <input id="nombre" type="text" class="form-control" placeholder="Nombre y Apellido"
                                                       th:field="*{nombre}">
                                            </div>
                                            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('nombre')}"
                                                 th:errors="*{nombre}">Error</div>
                                        </div>

                                        <div class="form-group col-md-6">
                                            <label for="email">Email</label>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                                </div>
                                                <input id="email" type="email" class="form-control" placeholder="correo@empresa.com"
                                                       th:field="*{email}">
                                            </div>
                                            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('email')}"
                                                 th:errors="*{email}">Error</div>
                                        </div>
                                    </div>

                                    <!-- Teléfono + Rol -->
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="telefono">Teléfono</label>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                                </div>
                                                <input id="telefono" type="text" class="form-control" placeholder="Ej. +56 9 9999 9999"
                                                       th:field="*{telefono}">
                                            </div>
                                            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('telefono')}"
                                                 th:errors="*{telefono}">Error</div>
                                        </div>

                                        <div class="form-group col-md-6">
                                            <label for="rol">Rol</label>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text"><i class="fas fa-user-shield"></i></span>
                                                </div>
                                                <select id="rol" class="form-control" th:field="*{rol}">
                                                    <option value="" disabled th:selected="${form.rol == null}">Selecciona un rol…</option>
                                                    <option th:each="r : ${roles}" th:value="${r}" th:text="${r}">ROL</option>
                                                </select>
                                            </div>
                                            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('rol')}"
                                                 th:errors="*{rol}">Error</div>
                                        </div>
                                    </div>

                                    <!-- Password + Confirmación (NO precargadas) -->
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="password" th:text="${form.rut != null ? 'Nueva contraseña (opcional)' : 'Contraseña'}">Contraseña</label>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                                </div>
                                                <input id="password" type="password" class="form-control" placeholder="••••••••"
                                                       th:field="*{password}">
                                            </div>
                                            <small class="form-text text-muted" th:if="${form.rut != null}">
                                                Déjalo vacío para no cambiarla.
                                            </small>
                                            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('password')}"
                                                 th:errors="*{password}">Error</div>
                                        </div>

                                        <div class="form-group col-md-6">
                                            <label for="confirmPassword">Confirmar contraseña</label>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                                </div>
                                                <input id="confirmPassword" type="password" class="form-control" placeholder="Repite la contraseña"
                                                       th:field="*{confirmPassword}">
                                            </div>
                                            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('confirmPassword')}"
                                                 th:errors="*{confirmPassword}">Error</div>
                                        </div>
                                    </div>

                                    <!-- Botones -->
                                    <div class="mt-3 d-flex align-items-center">
                                        <button id="btnGuardar" type="submit" class="btn btn-success mr-2">
                                            <i class="fas fa-save mr-1"></i> Guardar cambios
                                        </button>
                                        <a class="btn btn-outline-secondary" th:href="@{/empleados}">
                                            <i class="fas fa-times mr-1"></i> Cancelar
                                        </a>
                                    </div>
                                </form>

                            </div>
                        </div>
                    </div>
                </div>

            </div><!-- /.container-fluid -->
        </div>

        <footer class="sticky-footer bg-white">
            <div class="container my-auto">
                <div class="copyright text-center my-auto"><span>&copy; Inventario 2025</span></div>
            </div>
        </footer>
    </div>
</div>

<!-- ====== MODAL ÉXITO ====== -->
<div class="modal fade" id="modalSuccess" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-success">
                <h5 class="modal-title"><i class="fas fa-check-circle mr-2"></i> Operación exitosa</h5>
            </div>
            <div class="modal-body">
                <p class="mb-0">Cambios guardados correctamente.</p>
            </div>
        </div>
    </div>
</div>

<!-- ====== MODAL ERROR ====== -->
<div class="modal fade" id="modalError" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-error">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle mr-2"></i> Error</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Cerrar">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p class="mb-2">Ocurrió un problema. Revisa los campos o inténtalo de nuevo.</p>
                <pre id="modalErrorDetail" class="small mb-0" style="white-space:pre-wrap;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<a class="scroll-to-top rounded" href="#page-top"><i class="fas fa-angle-up"></i></a>

<script th:src="@{/vendor/jquery/jquery.min.js}"></script>
<script th:src="@{/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/vendor/jquery-easing/jquery.easing.min.js}"></script>
<script th:src="@{/js/sb-admin-2.min.js}"></script>

<script>
    (function () {
        const $form = $('#empleadoForm');
        if ($form.length === 0) return;

        const actionUrl   = $form.data('action-url');
        const $btnGuardar = $('#btnGuardar');

        /* ================== RUT (solo estética; guarda 9 exactos) ================== */
        const $rut = $('#rut');
        const MAX_COMPACT = 9; // 7-8 dígitos + 1 DV = 9

        function cleanCompact(v){
            return String(v || '').toUpperCase().replace(/[^0-9K]/g, '').slice(0, MAX_COMPACT);
        }
        function formatBodyWithDots(body){
            const rev = body.split('').reverse().join('');
            const groups = rev.match(/.{1,3}/g) || [];
            return groups.join('.').split('').reverse().join('');
        }
        function formatVisualFromCompact(compact){
            const n = compact.length;
            if (n === 0) return '';
            if (n === 1) return compact;                   // 1 char: aún sin guion
            const body = compact.slice(0, n - 1);          // lo que no es último char
            const dv   = compact.slice(-1);                // último char
            return `${formatBodyWithDots(body)}-${dv}`;    // cuerpo-DV
        }
        function setVisualFromInput(el){
            const compact = cleanCompact(el.value);
            $(el).data('compact', compact);
            el.value = formatVisualFromCompact(compact);
            setTimeout(() => { try { el.selectionStart = el.selectionEnd = el.value.length; } catch(_){} }, 0);
        }

        // Inicializa desde el valor que venga del servidor (puede venir con puntos/guion)
        (function initRut(){
            const initialCompact = cleanCompact($rut.val());
            $rut.data('compact', initialCompact);
            $rut.val(formatVisualFromCompact(initialCompact));
            $rut.on('input', function(e){ setVisualFromInput(e.target); });
            $rut.on('blur',  function(e){ setVisualFromInput(e.target); });
        })();

        /* ================== Foto (nueva selección) ================== */
        const $file   = $('#foto');
        const $btnSel = $('#btnSelectFoto');
        const $btnClr = $('#btnClearFoto');
        const $prev   = $('#fotoPreview');
        const $meta   = $('#fotoMeta');
        const $err    = $('#fotoError');

        if ($btnSel.length) $btnSel.on('click', () => $file.trigger('click'));
        if ($btnClr.length) $btnClr.on('click', () => clearFoto());

        function humanSize(n){
            if (!n) return '0 B';
            const u = ['B','KB','MB','GB']; let i=0; let v=n;
            while (v>=1024 && i<u.length-1){ v/=1024; i++; }
            return v.toFixed(i?1:0)+' '+u[i];
        }
        function clearFoto(){
            $file.val('');
            $prev.addClass('d-none').attr('src','');
            if ($btnClr.length) $btnClr.addClass('d-none');
            $err.addClass('d-none').text('');
            $meta.text('JPG/PNG/WebP. Máx 2 MB.');
        }
        $file.on('change', () => {
            $err.addClass('d-none').text('');
            const f = $file[0].files && $file[0].files[0];
            if (!f) { clearFoto(); return; }
            if (!f.type || !f.type.startsWith('image/')) {
                $err.removeClass('d-none').text('Selecciona un archivo de imagen válido.');
                clearFoto(); return;
            }
            if (f.size > 2_000_000) {
                $err.removeClass('d-none').text('La imagen supera 2 MB.');
                clearFoto(); return;
            }
            const url = URL.createObjectURL(f);
            $prev.attr('src', url).removeClass('d-none');
            if ($btnClr.length) $btnClr.removeClass('d-none');
            $meta.html(`<span class="text-mono">${f.name}</span> · ${humanSize(f.size)}`);
        });

        /* ================== Validación ligera ================== */
        function validateClient(){
            const compact = $rut.data('compact') || cleanCompact($rut.val());
            const nombre = $('#nombre').val().trim();
            const email  = $('#email').val().trim();
            const rol    = $('#rol').val();
            const pass   = $('#password').val();
            const conf   = $('#confirmPassword').val();

            if (!compact) return 'El RUT es obligatorio';
            if (!/^\d{7,8}[0-9K]$/.test(compact) || compact.length !== 9)
                return 'El RUT debe tener 9 caracteres (7–8 dígitos + DV).';

            if (!nombre) return 'El nombre es obligatorio';

            if (!email) return 'El correo es obligatorio';
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!re.test(email)) return 'El correo no es válido';

            if (!rol) return 'Debes seleccionar un rol';

            // En edición, password es opcional
            if (pass && pass.length < 6) return 'La nueva contraseña debe tener al menos 6 caracteres';
            if (pass && pass !== conf)   return 'Las contraseñas no coinciden';

            return null;
        }

        /* ================== Subir foto (usa SIEMPRE RUT 9) ================== */
        async function subirFotoSiExiste(rut9){
            const f = $file[0].files && $file[0].files[0];
            if (!f) return;
            const token  = $('meta[name="_csrf"]').attr('content');
            const header = $('meta[name="_csrf_header"]').attr('content');
            const fd = new FormData(); fd.append('file', f);
            const res = await fetch(`/empleados/${encodeURIComponent(rut9)}/foto`, {
                method: 'POST',
                headers: Object.assign({ 'X-Requested-With': 'XMLHttpRequest' }, header ? { [header]: token } : {}),
                body: fd
            });
            if (!res.ok) {
                const txt = await res.text().catch(()=> '');
                throw new Error(txt || `Error subiendo foto (HTTP ${res.status})`);
            }
        }

        function showSuccessThenRedirect(){
            $('#modalSuccess').modal({ backdrop: 'static', keyboard: false });
            $('#modalSuccess').modal('show');
            setTimeout(() => { window.location.href = '/empleados'; }, 1200);
        }
        function showError(detail){
            console.error('[ERROR]', detail);
            $('#modalErrorDetail').text(typeof detail === 'string' ? detail : JSON.stringify(detail, null, 2));
            $('#modalError').modal({ backdrop: 'static', keyboard: true });
            $('#modalError').modal('show');
        }

        /* ================== Submit (editar) ================== */
        $form.on('submit', function (ev) {
            ev.preventDefault();

            const err = validateClient();
            if (err) { showError(err); return; }

            const token  = $('meta[name="_csrf"]').attr('content');
            const header = $('meta[name="_csrf_header"]').attr('content');

            // EXACTAMENTE lo que el usuario escribió (limpio, sin puntos/guion), 9 exactos
            const compactFromUI = ($rut.data('compact') || cleanCompact($rut.val()));
            if (compactFromUI.length !== 9) {
                showError('El RUT debe tener 9 caracteres (cuerpo+DV).');
                return;
            }
            const rut9 = compactFromUI;

            const formData = new FormData(this);
            formData.set('rut', rut9);

            // Password vacío no se envía (evita validaciones innecesarias)
            if (!formData.get('password')) {
                formData.delete('password');
                formData.delete('confirmPassword');
            }

            $btnGuardar.prop('disabled', true).addClass('disabled');

            fetch(actionUrl, {
                method: 'POST',
                body: formData,
                headers: Object.assign(
                    { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                    header ? { [header]: token } : {}
                ),
                redirect: 'follow'
            })
                .then(async (res) => {
                    const ct = res.headers.get('content-type') || '';
                    if (!ct.includes('application/json')) {
                        try { await subirFotoSiExiste(rut9); } catch(e){ console.warn(e); }
                        showSuccessThenRedirect();
                        return;
                    }
                    const payload = await res.json().catch(() => ({}));
                    if (!res.ok || payload.ok === false) {
                        if (payload && payload.errors) {
                            const lines = [];
                            for (const k in payload.errors) {
                                if (Array.isArray(payload.errors[k])) {
                                    payload.errors[k].forEach(msg => lines.push(`${k}: ${msg}`));
                                } else if (payload.errors[k]) {
                                    lines.push(`${k}: ${payload.errors[k]}`);
                                }
                            }
                            if (lines.length) throw new Error('Validación falló\n' + lines.join('\n'));
                        }
                        throw new Error(payload.error || 'Validación falló');
                    }
                    await subirFotoSiExiste(rut9);
                    showSuccessThenRedirect();
                })
                .catch((e) => { showError(e && e.message ? e.message : e); })
                .finally(() => { $btnGuardar.prop('disabled', false).removeClass('disabled'); });
        });

        /* ================== Eliminar (usa RUT 9) ================== */
        $('#btnEliminar').on('click', async function () {
            const nombre = ($('#nombre').val() || '').trim();
            const compact = $rut.data('compact') || cleanCompact($rut.val());
            if (compact.length !== 9) { showError('RUT inválido para eliminar.'); return; }

            const visual = formatVisualFromCompact(compact);
            const msg = `¿Seguro que deseas eliminar a ${nombre || 'este empleado'} (${visual})? Esta acción no se puede deshacer.`;
            if (!confirm(msg)) return;

            const token  = $('meta[name="_csrf"]').attr('content');
            const header = $('meta[name="_csrf_header"]').attr('content');

            try {
                const res = await fetch(`/empleados/${encodeURIComponent(compact)}/eliminar`, {
                    method: 'POST', // o DELETE si tu backend lo expone
                    headers: Object.assign(
                        { 'X-Requested-With': 'XMLHttpRequest' },
                        header ? { [header]: token } : {}
                    )
                });
                if (!res.ok) {
                    const txt = await res.text().catch(()=> '');
                    throw new Error(txt || `HTTP ${res.status}`);
                }
                window.location.href = '/empleados';
            } catch (e) {
                showError(e && e.message ? e.message : e);
            }
        });

    })();
</script>



</body>
</html>
