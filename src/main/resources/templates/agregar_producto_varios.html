<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Agregar varios productos</title>

    <link th:href="@{/vendor/fontawesome-free/css/all.min.css}" rel="stylesheet"/>
    <link th:href="@{/css/sb-admin-2.min.css}" rel="stylesheet"/>

    <style>
        .create-ribbon{background:#e6fffa;border:1px solid #b2f5ea;color:#234e52}
        .badge-creating{font-size:.85rem}
        .table-products th,.table-products td{vertical-align:middle}
        .row-handle{cursor:grab;color:#718096}
        .img-preview{width:96px;height:96px;object-fit:cover;border-radius:.5rem;border:1px dashed #cbd5e0;background:#f8fafc;display:block;margin:0 auto}
        .minw-140{min-width:140px}.minw-120{min-width:120px}.minw-110{min-width:110px}.minw-90{min-width:90px}.mw-180{min-width:180px}
        .is-invalid + .invalid-feedback{display:block}
        .sticky-actions{position:sticky;bottom:0;background:#fff;z-index:10;border-top:1px solid #e2e8f0;box-shadow:0 -4px 12px rgba(0,0,0,.04)}
        /* Flags centrados */
        .flags-wrap{display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem;justify-items:center;align-items:center}
        .flag-switch{display:flex;flex-direction:column;align-items:center}
        .flag-switch i{font-size:1rem;color:#4b5563;margin-bottom:.15rem}
        /* Móvil: cards apiladas */
        @media (max-width: 991.98px){
            .table-products thead{display:none}
            .table-products,.table-products tbody,.table-products tr,.table-products td{display:block;width:100%}
            .table-products tr{background:#fff;border:1px solid #e5e7eb;border-radius:.75rem;padding:.75rem;margin:.75rem 0;box-shadow:0 3px 10px rgba(0,0,0,.03)}
            .table-products td{border:none;padding:.45rem 0}
            .stack-label{display:block;font-size:.78rem;color:#6b7280;margin-bottom:.25rem}
            .row-handle{display:none}
            .sticky-actions{position:static;box-shadow:none;border-top:none}
        }
    </style>
</head>
<body id="page-top">
<div id="wrapper">
    <div th:replace="~{menugeneral :: sidebar}"></div>

    <div id="content-wrapper" class="d-flex flex-column">
        <div id="content">
            <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
                <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3"><i class="fa fa-bars"></i></button>
                <ul class="navbar-nav ml-auto"></ul>
            </nav>

            <div class="container-fluid">
                <div class="d-sm-flex align-items-center justify-content-between mb-3">
                    <h1 class="h3 text-gray-800 mb-0">
                        <i class="fas fa-layer-group mr-2"></i> Agregar varios productos
                        <span class="badge badge-info badge-creating ml-2"><i class="fas fa-wand-magic-sparkles mr-1"></i> Carga múltiple</span>
                    </h1>
                    <a class="btn btn-outline-secondary" th:href="@{/buscar}"><i class="fas fa-arrow-left mr-1"></i> Volver</a>
                </div>

                <div class="alert create-ribbon" role="alert">
                    <i class="fas fa-info-circle mr-1"></i>
                    Completa los datos y presiona <strong>Guardar todo</strong>. La imagen es opcional.
                </div>

                <div class="alert alert-danger" th:if="${globalErrors != null and !#lists.isEmpty(globalErrors)}">
                    <h5 class="mb-2"><i class="fas fa-triangle-exclamation mr-1"></i> Revisa estos errores del lote</h5>
                    <ul class="mb-0 pl-3"><li th:each="msg : ${globalErrors}" th:text="${msg}">Mensaje</li></ul>
                </div>

                <form th:action="@{/productos/agregar-varios}" method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                    <div class="card shadow-sm">
                        <div class="card-header py-3 d-flex justify-content-between align-items-center">
                            <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-table mr-1"></i> Productos a cargar</h6>
                            <div class="btn-group">
                                <button type="button" id="btnAdd5" class="btn btn-outline-primary btn-sm"><i class="fas fa-plus mr-1"></i> Añadir 5 filas</button>
                                <button type="button" id="btnAdd1" class="btn btn-primary btn-sm"><i class="fas fa-plus-square mr-1"></i> Añadir 1 fila</button>
                            </div>
                        </div>

                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-striped mb-0 table-products">
                                    <thead class="thead-light">
                                    <tr>
                                        <th class="text-center minw-90"><i class="fas fa-grip-lines-vertical"></i></th>
                                        <th class="mw-180"><i class="fas fa-barcode mr-1"></i> Código de barras <span class="text-danger">*</span></th>
                                        <th class="mw-180">Nombre <span class="text-danger">*</span></th>
                                        <th class="minw-140">Marca</th>
                                        <th class="minw-140">Categoría <span class="text-danger">*</span></th>
                                        <th class="minw-140">Unidad <span class="text-danger">*</span></th>
                                        <th class="minw-110">Vol. (ml)</th>
                                        <th class="minw-110">Grad. (%)</th>
                                        <th class="minw-140">Vencimiento</th>
                                        <th class="minw-110">Stock</th>
                                        <th class="minw-110">Mín.</th>
                                        <th class="text-center minw-140">Flags</th>
                                        <th class="minw-200">Imagen</th>
                                        <th class="text-center minw-90">Acciones</th>
                                    </tr>
                                    </thead>

                                    <tbody id="tbodyProducts">
                                    <tr th:each="it, iStat : ${form.items}">
                                        <td class="text-center text-muted"><i class="fas fa-grip-vertical row-handle"></i></td>

                                        <!-- Código de barras PRIMERO -->
                                        <td>
                                            <span class="stack-label d-lg-none"><i class="fas fa-barcode mr-1"></i> Código de barras *</span>
                                            <div class="input-group">
                                                <div class="input-group-prepend d-none d-lg-flex">
                                                    <span class="input-group-text"><i class="fas fa-barcode"></i></span>
                                                </div>
                                                <input type="text" class="form-control js-cb" maxlength="32" placeholder="EAN/UPC" required
                                                       th:name="${'items[' + iStat.index + '].codigoBarras'}"
                                                       th:value="${it.codigoBarras}">
                                            </div>
                                            <div class="invalid-feedback">Obligatorio.</div>
                                        </td>

                                        <td>
                                            <span class="stack-label d-lg-none">Nombre *</span>
                                            <input type="text" class="form-control" placeholder="Nombre" required
                                                   th:name="${'items[' + iStat.index + '].nombre'}" th:value="${it.nombre}">
                                            <div class="invalid-feedback">Obligatorio.</div>
                                        </td>

                                        <td>
                                            <span class="stack-label d-lg-none">Marca</span>
                                            <input type="text" class="form-control" placeholder="Marca"
                                                   th:name="${'items[' + iStat.index + '].marca'}" th:value="${it.marca}">
                                        </td>

                                        <td>
                                            <span class="stack-label d-lg-none">Categoría *</span>
                                            <select class="form-control" required th:name="${'items[' + iStat.index + '].categoria'}">
                                                <option value="" disabled selected>— Selecciona —</option>
                                                <option th:each="c : ${T(com.inventario1.Inventario.models.Categoria).values()}"
                                                        th:value="${c}" th:text="${#strings.capitalize(c.name().toLowerCase())}"
                                                        th:selected="${it.categoria} == ${c}">
                                                </option>
                                            </select>
                                            <div class="invalid-feedback">Obligatorio.</div>
                                        </td>

                                        <td>
                                            <span class="stack-label d-lg-none">Unidad *</span>
                                            <select class="form-control" required th:name="${'items[' + iStat.index + '].unidadBase'}">
                                                <option value="" disabled selected>— Selecciona —</option>
                                                <option th:each="u : ${T(com.inventario1.Inventario.models.UnidadBase).values()}"
                                                        th:value="${u}" th:text="${#strings.capitalize(u.name().toLowerCase())}"
                                                        th:selected="${it.unidadBase} == ${u}">
                                                </option>
                                            </select>
                                            <div class="invalid-feedback">Obligatorio.</div>
                                        </td>

                                        <td>
                                            <span class="stack-label d-lg-none">Volumen (ml)</span>
                                            <input type="number" min="0" step="1" class="form-control" placeholder="ml"
                                                   th:name="${'items[' + iStat.index + '].volumenNominalMl'}" th:value="${it.volumenNominalMl}">
                                        </td>

                                        <td>
                                            <span class="stack-label d-lg-none">Grad. (%)</span>
                                            <input type="number" min="0" step="0.1" class="form-control" placeholder="%"
                                                   th:name="${'items[' + iStat.index + '].graduacionAlcoholica'}" th:value="${it.graduacionAlcoholica}">
                                        </td>

                                        <td>
                                            <span class="stack-label d-lg-none">Vencimiento</span>
                                            <input type="date" class="form-control"
                                                   th:name="${'items[' + iStat.index + '].fechaVencimiento'}"
                                                   th:value="${#temporals.format(it.fechaVencimiento, 'yyyy-MM-dd')}">
                                        </td>

                                        <td>
                                            <span class="stack-label d-lg-none">Stock</span>
                                            <input type="number" min="0" step="1" class="form-control" placeholder="0"
                                                   th:name="${'items[' + iStat.index + '].stockActual'}" th:value="${it.stockActual}">
                                        </td>

                                        <td>
                                            <span class="stack-label d-lg-none">Stock mínimo</span>
                                            <input type="number" min="0" step="1" class="form-control" placeholder="0"
                                                   th:name="${'items[' + iStat.index + '].stockMinimo'}" th:value="${it.stockMinimo}">
                                        </td>

                                        <!-- Flags CENTRADOS -->
                                        <td class="text-center">
                                            <span class="stack-label d-lg-none">Flags</span>
                                            <div class="flags-wrap">
                                                <label class="flag-switch">
                                                    <i class="fas fa-apple-alt" title="Perecible"></i>
                                                    <div class="custom-control custom-switch">
                                                        <input type="checkbox" class="custom-control-input"
                                                               th:id="${'perecible_'+iStat.index}"
                                                               th:name="${'items[' + iStat.index + '].perecible'}"
                                                               th:checked="${it.perecible}">
                                                        <label class="custom-control-label" th:for="${'perecible_'+iStat.index}"></label>
                                                    </div>
                                                </label>
                                                <label class="flag-switch">
                                                    <i class="fas fa-recycle" title="Retornable"></i>
                                                    <div class="custom-control custom-switch">
                                                        <input type="checkbox" class="custom-control-input"
                                                               th:id="${'retornable_'+iStat.index}"
                                                               th:name="${'items[' + iStat.index + '].retornable'}"
                                                               th:checked="${it.retornable}">
                                                        <label class="custom-control-label" th:for="${'retornable_'+iStat.index}"></label>
                                                    </div>
                                                </label>
                                                <label class="flag-switch">
                                                    <i class="fas fa-toggle-on" title="Activo"></i>
                                                    <div class="custom-control custom-switch">
                                                        <input type="checkbox" class="custom-control-input"
                                                               th:id="${'activo_'+iStat.index}"
                                                               th:name="${'items[' + iStat.index + '].activo'}"
                                                               th:checked="${it.activo}">
                                                        <label class="custom-control-label" th:for="${'activo_'+iStat.index}"></label>
                                                    </div>
                                                </label>
                                            </div>
                                        </td>

                                        <!-- Imagen: botón "Buscar" debajo y texto "Imagen" -->
                                        <td class="text-center">
                                            <span class="stack-label d-lg-none">Imagen</span>
                                            <img class="img-preview mb-2" th:src="@{/img/no-image.png}" alt="Prev.">
                                            <!-- input file oculto -->
                                            <input type="file" class="d-none js-img" th:id="${'imagen_'+iStat.index}"
                                                   th:name="${'imagenes[' + iStat.index + ']'}" accept="image/*">
                                            <!-- botón Buscar -->
                                            <button type="button" class="btn btn-sm btn-outline-secondary js-pick"
                                                    th:data-target-id="${'imagen_'+iStat.index}">
                                                Buscar
                                            </button>
                                            <div class="small text-muted mt-1">Imagen</div>
                                            <div class="small text-truncate mt-1 js-filename" style="max-width:160px;"></div>
                                        </td>

                                        <td class="text-center">
                                            <span class="stack-label d-lg-none">Acciones</span>
                                            <button type="button" class="btn btn-sm btn-outline-danger js-remove"><i class="fas fa-trash"></i></button>
                                        </td>
                                    </tr>
                                    </tbody>

                                    <tfoot>
                                    <tr class="sticky-actions">
                                        <td colspan="14" class="p-3">
                                            <div class="d-flex justify-content-between flex-wrap">
                                                <div class="btn-group mb-2">
                                                    <button type="button" id="btnClearAll" class="btn btn-warning"><i class="fas fa-broom mr-1"></i> Limpiar todo</button>
                                                    <button type="button" id="btnAdd10" class="btn btn-outline-primary"><i class="fas fa-plus mr-1"></i> Añadir 10 filas</button>
                                                </div>
                                                <div class="btn-group mb-2">
                                                    <button type="reset" class="btn btn-outline-secondary"><i class="fas fa-undo mr-1"></i> Restablecer</button>
                                                    <button type="submit" class="btn btn-primary"><i class="fas fa-save mr-1"></i> Guardar todo</button>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <footer class="sticky-footer bg-white">
            <div class="container my-auto">
                <div class="copyright text-center my-auto"><span>&copy; Inventario 2025</span></div>
            </div>
        </footer>
    </div>
</div>

<a class="scroll-to-top rounded" href="#page-top"><i class="fas fa-angle-up"></i></a>

<!-- Template para nuevas filas -->
<template id="row-template">
    <tr>
        <td class="text-center text-muted"><i class="fas fa-grip-vertical row-handle"></i></td>

        <td>
            <span class="stack-label d-lg-none"><i class="fas fa-barcode mr-1"></i> Código de barras *</span>
            <div class="input-group">
                <div class="input-group-prepend d-none d-lg-flex"><span class="input-group-text"><i class="fas fa-barcode"></i></span></div>
                <input type="text" name="items[__index__].codigoBarras" class="form-control js-cb" maxlength="32" placeholder="EAN/UPC" required>
            </div>
            <div class="invalid-feedback">Obligatorio.</div>
        </td>

        <td>
            <span class="stack-label d-lg-none">Nombre *</span>
            <input type="text" name="items[__index__].nombre" class="form-control" placeholder="Nombre" required>
            <div class="invalid-feedback">Obligatorio.</div>
        </td>

        <td><span class="stack-label d-lg-none">Marca</span><input type="text" name="items[__index__].marca" class="form-control" placeholder="Marca"></td>

        <td>
            <span class="stack-label d-lg-none">Categoría *</span>
            <select name="items[__index__].categoria" class="form-control" required>
                <option value="" disabled selected>— Selecciona —</option>
                <option th:each="c : ${T(com.inventario1.Inventario.models.Categoria).values()}" th:value="${c}" th:text="${#strings.capitalize(c.name().toLowerCase())}"></option>
            </select>
            <div class="invalid-feedback">Obligatorio.</div>
        </td>

        <td>
            <span class="stack-label d-lg-none">Unidad *</span>
            <select name="items[__index__].unidadBase" class="form-control" required>
                <option value="" disabled selected>— Selecciona —</option>
                <option th:each="u : ${T(com.inventario1.Inventario.models.UnidadBase).values()}" th:value="${u}" th:text="${#strings.capitalize(u.name().toLowerCase())}"></option>
            </select>
            <div class="invalid-feedback">Obligatorio.</div>
        </td>

        <td><span class="stack-label d-lg-none">Volumen (ml)</span><input type="number" min="0" step="1" name="items[__index__].volumenNominalMl" class="form-control" placeholder="ml"></td>
        <td><span class="stack-label d-lg-none">Grad. (%)</span><input type="number" min="0" step="0.1" name="items[__index__].graduacionAlcoholica" class="form-control" placeholder="%"></td>
        <td><span class="stack-label d-lg-none">Vencimiento</span><input type="date" name="items[__index__].fechaVencimiento" class="form-control"></td>
        <td><span class="stack-label d-lg-none">Stock</span><input type="number" min="0" step="1" name="items[__index__].stockActual" class="form-control" placeholder="0"></td>
        <td><span class="stack-label d-lg-none">Stock mínimo</span><input type="number" min="0" step="1" name="items[__index__].stockMinimo" class="form-control" placeholder="0"></td>

        <td class="text-center">
            <span class="stack-label d-lg-none">Flags</span>
            <div class="flags-wrap">
                <label class="flag-switch">
                    <i class="fas fa-apple-alt" title="Perecible"></i>
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" name="items[__index__].perecible" id="perecible___index__">
                        <label class="custom-control-label" for="perecible___index__"></label>
                    </div>
                </label>
                <label class="flag-switch">
                    <i class="fas fa-recycle" title="Retornable"></i>
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" name="items[__index__].retornable" id="retornable___index__">
                        <label class="custom-control-label" for="retornable___index__"></label>
                    </div>
                </label>
                <label class="flag-switch">
                    <i class="fas fa-toggle-on" title="Activo"></i>
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" name="items[__index__].activo" id="activo___index__" checked>
                        <label class="custom-control-label" for="activo___index__"></label>
                    </div>
                </label>
            </div>
        </td>

        <td class="text-center">
            <span class="stack-label d-lg-none">Imagen</span>
            <img class="img-preview mb-2" src="/img/no-image.png" alt="Prev.">
            <input type="file" class="d-none js-img" name="imagenes[__index__]" id="imagen___index__" accept="image/*">
            <button type="button" class="btn btn-sm btn-outline-secondary js-pick" data-target-id="imagen___index__">Buscar</button>
            <div class="small text-muted mt-1">Imagen</div>
            <div class="small text-truncate mt-1 js-filename" style="max-width:160px;"></div>
        </td>

        <td class="text-center">
            <span class="stack-label d-lg-none">Acciones</span>
            <button type="button" class="btn btn-sm btn-outline-danger js-remove"><i class="fas fa-trash"></i></button>
        </td>
    </tr>
</template>

<script th:src="@{/vendor/jquery/jquery.min.js}"></script>
<script th:src="@{/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/vendor/jquery-easing/jquery.easing.min.js}"></script>
<script th:src="@{/js/sb-admin-2.min.js}"></script>
<script>
    (function(){
        'use strict';
        const tbody=document.getElementById('tbodyProducts');
        const tpl=document.getElementById('row-template');
        const btnAdd1=document.getElementById('btnAdd1');
        const btnAdd5=document.getElementById('btnAdd5');
        const btnAdd10=document.getElementById('btnAdd10');
        const btnClear=document.getElementById('btnClearAll');

        function nextIndex(){
            const names=[...tbody.querySelectorAll('input,select,textarea')].map(el=>el.name).filter(Boolean);
            let max=-1; names.forEach(n=>{const m=n.match(/\[(\d+)]/); if(m) max=Math.max(max,parseInt(m[1],10));});
            return max+1;
        }
        function addRows(n){
            for(let k=0;k<n;k++){
                const idx=nextIndex();
                const html=tpl.innerHTML.replaceAll('__index__',String(idx));
                const tmp=document.createElement('tbody'); tmp.innerHTML=html.trim();
                tbody.appendChild(tmp.firstElementChild);
            }
            wireUpRowEvents();
        }
        function removeRow(btn){ const tr=btn.closest('tr'); if(tr && tbody.contains(tr)) tbody.removeChild(tr); }

        function wireUpRowEvents(){
            // Botón "Buscar" → click al input oculto
            tbody.querySelectorAll('button.js-pick').forEach(btn=>{
                if (btn._boundPick) return; btn._boundPick=true;
                btn.addEventListener('click',()=>{
                    const id = btn.getAttribute('data-target-id');
                    const input = id ? document.getElementById(id) : btn.previousElementSibling;
                    if (input) input.click();
                });
            });

            // Preview + nombre de archivo
            tbody.querySelectorAll('input.js-img').forEach(input=>{
                if(input._boundImg) return; input._boundImg=true;
                input.addEventListener('change',()=>{
                    const f=input.files && input.files[0];
                    const cell = input.closest('td');
                    const img  = cell.querySelector('.img-preview');
                    const nameBox = cell.querySelector('.js-filename');
                    if(f){
                        if(nameBox) nameBox.textContent=f.name;
                        const r=new FileReader();
                        r.onload=e=>{ if(img) img.src=e.target.result; };
                        r.readAsDataURL(f);
                    }else{
                        if(nameBox) nameBox.textContent='';
                        if(img) img.src='/img/no-image.png';
                    }
                });
            });

            // Eliminar fila
            tbody.querySelectorAll('.js-remove').forEach(btn=>{
                if(btn._boundRemove) return; btn._boundRemove=true;
                btn.addEventListener('click',()=>removeRow(btn));
            });

            // Código de barras: solo dígitos, máx 32
            tbody.querySelectorAll('input.js-cb').forEach(inp=>{
                if(inp._boundCB) return; inp._boundCB=true;
                inp.addEventListener('input',()=>{ inp.value=inp.value.replace(/[^\d]/g,'').slice(0,32); });
            });
        }

        if (document.getElementById('btnAdd1'))  btnAdd1.addEventListener('click',()=>addRows(1));
        if (document.getElementById('btnAdd5'))  btnAdd5.addEventListener('click',()=>addRows(5));
        if (document.getElementById('btnAdd10')) btnAdd10.addEventListener('click',()=>addRows(10));
        if (document.getElementById('btnClearAll')) btnClear.addEventListener('click',()=>{ if(confirm('¿Quitar todas las filas?')) tbody.innerHTML=''; });

        window.addEventListener('DOMContentLoaded',()=>{ if(!tbody.querySelector('tr')) addRows(5); else wireUpRowEvents(); });

        const forms=document.getElementsByClassName('needs-validation');
        Array.prototype.slice.call(forms).forEach(function(form){
            form.addEventListener('submit',function(e){ if(!form.checkValidity()){ e.preventDefault(); e.stopPropagation(); } form.classList.add('was-validated'); },false);
        });
    })();
</script>
</body>
</html>
