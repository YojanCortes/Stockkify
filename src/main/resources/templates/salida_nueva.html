<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Inventario Â· Salida de productos</title>

    <!-- Estilos -->
    <link th:href="@{/vendor/fontawesome-free/css/all.min.css}" rel="stylesheet" />
    <link th:href="@{/css/sb-admin-2.min.css}" rel="stylesheet" />
    <link th:href="@{/css/sacarproducto.css}" rel="stylesheet" />

    <!-- CSRF (Spring Security) -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<body>

<!-- TOPBAR -->
<div class="pos-topbar">
    <div class="pos-title">Inventario Â· Salida de productos</div>
    <div style="margin-left:auto; display:flex; align-items:center; gap:12px;">
        <i class="far fa-bell"></i>
        <div style="width:32px;height:32px;border-radius:50%;background:#2c4d6b;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700">U</div>
    </div>
</div>

<div class="pos-shell">
    <!-- SIDEBAR -->
    <aside class="pos-sidebar">
        <div class="pos-side-btn" title="Productos"><i class="fas fa-th-large"></i></div>
        <div class="pos-side-btn" title="Movimientos"><i class="fas fa-clipboard-list"></i></div>
        <div class="pos-side-btn" title="Usuarios"><i class="fas fa-users"></i></div>
        <div class="pos-side-btn" title="Ajustes"><i class="fas fa-cog"></i></div>
        <div style="margin-top:auto" class="pos-side-btn" title="Salir"><i class="fas fa-power-off"></i></div>
    </aside>

    <!-- MAIN -->
    <main class="pos-main">
        <!-- IZQUIERDA: Lista de productos -->
        <section class="card">
            <div class="card-body">
                <!-- Formulario para agregar por cÃ³digo -->
                <form id="addByCodeForm" class="add-form" autocomplete="off">
                    <input type="text" id="codeInput" name="code" placeholder="Escanea o ingresa cÃ³digo de barrasâ€¦" />
                    <button class="icon-btn" title="Agregar" type="submit">
                        <i class="fas fa-plus"></i>
                    </button>
                </form>
                <div id="formMsg" class="form-msg" aria-live="polite"></div>
            </div>

            <div class="card-header">
                <div style="opacity:.7;font-weight:700">PRODUCTO</div>
                <div style="opacity:.7;font-weight:700">ACCIONES</div>
            </div>

            <!-- ðŸŸ¢ CONTENEDOR DEL LISTADO (para AJAX) -->
            <div id="productosContainer">
                <!-- Loop de productos -->
                <div class="product-row"
                     th:each="p : ${productos}"
                     th:attr="data-code=${p.id},data-name=${p.nombre},data-stock=${p.stockActual}">
                    <div class="thumb">
                        <img th:src="@{|/productos/${p.id}/imagen|}" alt=""
                             onerror="this.style.display='none';this.parentElement.querySelector('.no-img').style.display='flex'">
                        <div class="no-img">Sin imagen</div>
                    </div>
                    <div>
                        <div class="p-name" th:text="${p.nombre}">Nombre</div>
                        <div class="p-tags">
                            <span class="tag" th:if="${p.categoria != null}" th:text="${p.categoria}">CategorÃ­a</span>
                            <span class="tag" th:if="${p.marca != null}" th:text="${p.marca}">Marca</span>
                        </div>
                        <div class="subtext">
                            CÃ³digo: <span th:text="${p.id}">000</span> Â·
                            Disp.: <span th:text="${p.stockActual}">0</span>
                        </div>
                    </div>
                    <div class="add-circle" data-open-qty title="Agregar a salida"><i class="fas fa-plus"></i></div>
                </div>

                <!-- Pie de lista -->
                <div style="display:flex; justify-content:space-between; padding:12px 14px; color:#6c7a8c; font-size:.9rem;">
                    <div>
                        Mostrando
                        <span th:text="${#lists.size(productos)}">0</span>
                        <span th:if="${totalElements != null}">
                          de <span th:text="${totalElements}">0</span>
                        </span>
                    </div>
                    <div>Usa el lector para agregar mÃ¡s rÃ¡pido</div>
                </div>

                <!-- ðŸŸ¢ CONTENEDOR DEL PAGINADOR (para AJAX) -->
                <div th:if="${totalPages != null and totalPages > 1}" style="padding:0 14px 12px;" id="paginadorContainer">
                    <nav>
                        <ul class="pagination mb-0">
                            <li class="page-item" th:classappend="${page == 0} ? 'disabled' : ''">
                                <a class="page-link" th:href="@{/salidas/nueva(q=${q}, page=${page - 1})}">Anterior</a>
                            </li>
                            <li class="page-item" th:each="i : ${#numbers.sequence(0, (totalPages - 1))}"
                                th:classappend="${i == page} ? 'active' : ''">
                                <a class="page-link" th:text="${i + 1}" th:href="@{/salidas/nueva(q=${q}, page=${i})}">1</a>
                            </li>
                            <li class="page-item" th:classappend="${(page + 1) >= totalPages} ? 'disabled' : ''">
                                <a class="page-link" th:href="@{/salidas/nueva(q=${q}, page=${page + 1})}">Siguiente</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </section>

        <!-- DERECHA: Salida actual -->
        <section class="card" style="position:relative">
            <div class="card-body">
                <div class="cart-head">
                    <strong>Salida actual</strong>
                    <span class="chip">Usuario:
                        <!-- Si estÃ¡ autenticado muestra su username; si es anÃ³nimo muestra Invitado -->
                        <span sec:authorize="isAuthenticated()" sec:authentication="name">Invitado</span>
                        <span sec:authorize="isAnonymous()">Invitado</span>
                    </span>
                </div>
            </div>

            <div class="cart-list" id="cartList">
                <div class="subtext" id="emptyHint" style="padding:14px;">
                    AÃºn no hay productos en la salida.
                </div>
            </div>

            <!-- Resumen -->
            <div class="summary">
                <div class="box">
                    <div class="k">Productos distintos</div>
                    <div class="v" id="kinds">0</div>
                </div>
                <div class="box">
                    <div class="k">Unidades totales</div>
                    <div class="v" id="units">0</div>
                </div>
            </div>

            <!-- Campos globales -->
            <div class="globals">
                <input type="text" id="motivo" placeholder="Motivo (ej. Venta, Mermaâ€¦)" />
                <input type="text" id="referencia" placeholder="Referencia (NÂ° doc, notaâ€¦)" />
                <input type="text" id="usuario" placeholder="Usuario (opcional)"
                       th:value="${#authorization.expression('isAuthenticated()') ? #authentication.name : 'Invitado'}" />
            </div>

            <!-- Acciones -->
            <div class="actions">
                <button type="button" class="btn-outline" id="btnVaciar" title="Vaciar carrito de salida">
                    <i class="fas fa-trash-alt mr-1"></i> Vaciar
                </button>
                <div class="flex-spacer" style="flex:1"></div>
                <button type="button" class="btn-success" id="btnRegistrar" title="Registrar salida en el sistema">
                    <i class="fas fa-check mr-1"></i> Registrar salida
                </button>
            </div>

            <!-- Modal cantidad -->
            <div class="variant-pop" id="qtyPop">
                <div class="variant-section">
                    <div class="label">Cantidad</div>
                    <div class="row">
                        <input type="number" id="qtyInput" min="1" step="1" value="1" />
                    </div>
                </div>
                <div class="variant-section">
                    <button class="btn-primary" id="addToCartBtn">Agregar a salida</button>
                </div>
            </div>

            <!-- Backdrop -->
            <div class="modal-backdrop" id="qtyBackdrop"></div>
        </section>
    </main>
</div>

<!-- Scripts -->
<script th:src="@{/vendor/fontawesome-free/js/all.min.js}"></script>
<script th:src="@{/js/salidas.js}"></script>
</body>
</html>
