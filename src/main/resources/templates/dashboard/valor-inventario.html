<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>KPI 4 — Valor Total de Inventario (CLP)</title>
    <style>
        :root { --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --accent:#22c55e; --line:#2b3446; }
        *{box-sizing:border-box}
        body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;background:linear-gradient(180deg,#0b1220,#0f172a);color:var(--text)}
        header{padding:18px 22px;border-bottom:1px solid rgba(255,255,255,.06);background:rgba(15,23,42,.85);backdrop-filter:blur(8px);position:sticky;top:0}
        .wrap{max-width:1080px;margin:0 auto;padding:22px}
        h1{margin:0;font-size:1.25rem}
        h2{margin:.25rem 0 1rem;color:var(--muted);font-size:.95rem}
        .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
        .col-4{grid-column:span 4} .col-8{grid-column:span 8} .col-12{grid-column:span 12}
        @media(max-width:900px){.col-4,.col-8{grid-column:span 12}}
        .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
        .kpi{font-size:2rem;font-weight:800}
        .sub{color:var(--muted);font-size:.9rem}
        .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:.9rem;margin-right:8px}
        table{width:100%;border-collapse:collapse;margin-top:8px}
        th,td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
        th{color:var(--muted);font-weight:600;font-size:.9rem}
        tr:hover td{background:rgba(255,255,255,.03)}
        .bar{height:10px;background:#334155;border-radius:999px;overflow:hidden}
        .bar>i{display:block;height:100%;background:linear-gradient(90deg,#60a5fa,#22c55e);width:0%}
        .back{display:inline-block;margin-top:18px;text-decoration:none;color:#93c5fd;border:1px solid rgba(147,197,253,.3);padding:8px 12px;border-radius:10px}
        .err{color:#fda4af;font-size:.9rem;margin-top:6px}
        .loading{color:var(--muted);font-size:.9rem}
    </style>
</head>
<body>
<header><div class="wrap"><h1>KPI 4 — Valor Total de Inventario (CLP)</h1></div></header>

<main class="wrap">
    <section class="grid">
        <div class="card col-4">
            <h2>Valor total</h2>
            <div class="kpi" id="kpiValor">CLP —</div>
            <div class="sub">Σ (precio × cantidad)</div>
            <div class="pill" id="pillItems">— ítems</div>
            <div class="pill" id="pillProm">Prom. por ítem: CLP —</div>
            <div class="err" id="errTotal" style="display:none"></div>
        </div>

        <div class="card col-8">
            <h2>Valor por categoría</h2>
            <div id="catState" class="loading">Cargando…</div>
            <table>
                <thead>
                <tr>
                    <th>Categoría</th>
                    <th>Valor (CLP)</th>
                    <th style="width:40%">Distribución</th>
                </tr>
                </thead>
                <tbody id="tbCat">
                <!-- filas dinámicas -->
                </tbody>
            </table>
        </div>
    </section>

    <section class="card" style="margin-top:16px">
        <h2>Notas</h2>
        <p class="sub" style="margin:0">
            Útil para control financiero y toma de decisiones de compra. Revisa mensualmente variaciones relevantes.
        </p>
    </section>

    <a class="back" href="/dashboard">← Volver</a>
</main>

<script>
    const API = '/api/dashboard/kpi4';
    const fmtCLP = v => (Number(v)||0).toLocaleString('es-CL', { style:'currency', currency:'CLP', maximumFractionDigits:0 });

    async function loadKpi4(){
      const elValor = document.getElementById('kpiValor');
      const elItems = document.getElementById('pillItems');
      const elProm  = document.getElementById('pillProm');
      const elErr   = document.getElementById('errTotal');
      const tbCat   = document.getElementById('tbCat');
      const catState= document.getElementById('catState');

      elErr.style.display='none'; elErr.textContent='';
      catState.style.display='block'; catState.textContent='Cargando…';
      tbCat.innerHTML='';

      try{
        const r = await fetch(API, { headers:{ 'Accept':'application/json' }});
        if(!r.ok) throw new Error('HTTP '+r.status);
        const d = await r.json();

        // Campos tolerantes a nombre
        const totalValor = d.totalValorCLP ?? d.totalValor ?? d.total ?? 0;
        const totalItems = d.totalItems ?? 0;
        const promItem   = d.promedioPorItem ?? (totalItems>0 ? Math.round(totalValor/totalItems) : 0);

        elValor.textContent = fmtCLP(totalValor);
        elItems.textContent = `${(totalItems||0).toLocaleString('es-CL')} ítems`;
        elProm.textContent  = `Prom. por ítem: ${fmtCLP(promItem)}`;

        const catsRaw = Array.isArray(d.categorias) ? d.categorias : [];
        const cats = catsRaw.map(c => ({
          nombre: c.categoria || 'GENERAL',
          valor:  c.valorCLP ?? c.valor ?? 0
        }))
        .filter(c => c.valor >= 0)
        .sort((a,b)=>b.valor-a.valor);

        catState.style.display='none';

        if(cats.length===0){
          tbCat.innerHTML = `<tr><td colspan="3" class="sub">Sin categorías con valor.</td></tr>`;
          return;
        }

        const max = Math.max(...cats.map(c=>c.valor), 1);

        tbCat.innerHTML = cats.map(c => `
          <tr>
            <td>${c.nombre}</td>
            <td>${fmtCLP(c.valor)}</td>
            <td><div class="bar"><i style="width:${(c.valor/max*100).toFixed(0)}%"></i></div></td>
          </tr>
        `).join('');

      }catch(err){
        console.error('KPI4 error', err);
        elErr.style.display='block';
        elErr.textContent='No se pudo cargar el KPI 4.';
        elValor.textContent = 'CLP —';
        elItems.textContent = '— ítems';
        elProm.textContent  = 'Prom. por ítem: CLP —';
        catState.style.display='block';
        catState.textContent='Error al cargar categorías.';
        tbCat.innerHTML='';
      }
    }

    // Carga inicial
    loadKpi4();
</script>
</body>
</html>
