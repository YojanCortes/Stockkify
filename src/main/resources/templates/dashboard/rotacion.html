<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Rotación de Inventario (mensual)</title>
    <style>
        :root{
          --bg:#0f172a; --card:#0b1220; --card2:#111827; --text:#e5e7eb; --muted:#9ca3af;
          --ring:#334155; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --primary:#93c5fd; --line:#1f2937
        }
        *{box-sizing:border-box}
        body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;background:linear-gradient(180deg,#0b1020,#0f172a);color:var(--text)}
        header{padding:20px 22px;border-bottom:1px solid rgba(255,255,255,.06);position:sticky;top:0;background:rgba(11,16,32,.9);backdrop-filter:blur(10px)}
        .wrap{max-width:1280px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:12px}
        .title{margin:0;font-size:1.5rem;letter-spacing:-.3px}
        .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);text-decoration:none;color:#0b1020;background:#e5e7eb;font-weight:700}
        .btn-ghost{background:transparent;color:var(--text);border-color:rgba(255,255,255,.15)}
        .btn:disabled{opacity:.6;cursor:not-allowed}

        .container{max-width:1280px;margin:0 auto;padding:22px}
        .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:18px}
        .col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-5{grid-column:span 5}.col-6{grid-column:span 6}.col-7{grid-column:span 7}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
        @media (max-width:1100px){.col-7,.col-5,.col-4,.col-3,.col-6,.col-8{grid-column:span 12}}

        .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:18px;box-shadow:0 16px 36px rgba(0,0,0,.35)}
        .card2{background:var(--card2);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px}
        .muted{color:var(--muted)}
        .kpi-xl{font-size:2.4rem;font-weight:900;letter-spacing:-.3px}
        .kpi{font-size:1.6rem;font-weight:800}
        .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
        .row-between{display:flex;align-items:center;justify-content:space-between;gap:10px}
        .badge{font-size:.8rem;padding:5px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06)}
        .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.1);font-size:.9rem}
        .pill.ok{color:var(--ok);border-color:rgba(34,197,94,.4)} .pill.warn{color:var(--warn);border-color:rgba(245,158,11,.4)} .pill.bad{color:var(--bad);border-color:rgba(239,68,68,.4)}

        .inputs{display:flex;gap:12px;flex-wrap:wrap}
        .input{display:flex;flex-direction:column;gap:6px}
        .input label{font-size:.86rem;color:var(--muted)}
        .select,.input input{height:42px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:#0a0f1e;color:var(--text);padding:0 12px;min-width:160px}
        .select{appearance:none;background-image:linear-gradient(45deg,transparent 50%,#93c5fd 50%),linear-gradient(135deg,#93c5fd 50%,transparent 50%),linear-gradient(to right,transparent,transparent);background-position:calc(100% - 18px) 17px,calc(100% - 10px) 17px,100% 0;background-size:8px 8px,8px 8px,2.8em 2.8em;background-repeat:no-repeat}

        .ring{--p:0;width:200px;height:200px;border-radius:50%;background:conic-gradient(#60a5fa calc(var(--p)*1%),var(--ring) 0);display:grid;place-items:center;border:6px solid #0b1220;box-shadow:inset 0 0 30px rgba(0,0,0,.35)}
        .ring .val{font-size:1.6rem;font-weight:900}
        .sub{font-size:.92rem;color:var(--muted)}

        .bar{height:12px;background:var(--line);border-radius:10px;overflow:hidden}
        .bar > i{display:block;height:100%;width:0;background:linear-gradient(90deg,#60a5fa,#34d399)}

        .table{width:100%;border-collapse:collapse}
        .table th,.table td{padding:12px;border-bottom:1px solid rgba(255,255,255,.06);text-align:left}
        .table th{color:var(--muted);font-weight:700;font-size:.9rem}
        .table tr:hover td{background:rgba(255,255,255,.03)}

        .error{color:#fda4af}
        small code{background:rgba(255,255,255,.06);padding:2px 6px;border-radius:6px}
    </style>
</head>
<body>
<header>
    <div class="wrap">
        <h1 class="title">Dashboard · Rotación de Inventario (mensual)</h1>
        <div class="row">
            <a class="btn-ghost btn" href="/index.html">Volver</a>
        </div>
    </div>
</header>

<main class="container">
    <!-- Filtros -->
    <section class="card col-12">
        <div class="row-between" style="gap:16px;flex-wrap:wrap">
            <div class="inputs">
                <div class="input">
                    <label for="sel-mes">Mes</label>
                    <select id="sel-mes" class="select"></select>
                </div>
                <div class="input">
                    <label for="sel-anio">Año</label>
                    <select id="sel-anio" class="select"></select>
                </div>
                <div class="input">
                    <label for="meta-rot">Meta de rotación (x)</label>
                    <input id="meta-rot" type="number" min="0" step="0.1" value="6.0"/>
                </div>
            </div>
            <div class="row">
                <button id="btn-refrescar" class="btn">Refrescar</button>
                <button id="btn-export" class="btn-ghost btn">Exportar KPI (CSV)</button>
            </div>
        </div>
        <small class="muted">Endpoint usado: <code>/api/dashboard/kpi1</code> (mes/año seleccionados son visuales).</small>
    </section>

    <!-- Hero KPI -->
    <section class="grid" style="margin-top:18px">
        <div class="card col-7">
            <div class="row" style="gap:22px;align-items:center">
                <div class="ring" id="ring" style="--p:0">
                    <div style="text-align:center">
                        <div class="val" id="rot">-- x</div>
                        <div class="sub">Rotación mensual</div>
                    </div>
                </div>
                <div style="flex:1;min-width:260px">
                    <div class="row-between">
                        <div class="kpi" id="tituloMes">Mes actual</div>
                        <span class="pill" id="estado">—</span>
                    </div>
                    <div class="sub" style="margin-top:6px">
                        Ventas netas: <b id="ventas">--</b> · Inventario promedio: <b id="inv">--</b>
                    </div>

                    <div class="card2" style="margin-top:14px">
                        <div class="row-between">
                            <span class="sub">Progreso vs meta</span>
                            <span class="sub"><b id="metaLabel">Meta: 6.0x</b></span>
                        </div>
                        <div class="bar" style="margin-top:8px"><i id="bar-meta" style="width:0%"></i></div>
                        <div class="row-between sub" style="margin-top:6px">
                            <span id="var">—</span>
                            <span id="anualizada">Anualizada: —</span>
                        </div>
                    </div>

                    <small class="sub" style="display:block;margin-top:10px">Fórmula: <code>ventas_netas / inventario_promedio</code></small>
                </div>
            </div>
            <div class="muted error" id="err" style="display:none;margin-top:8px"></div>
        </div>

        <!-- Mini KPIs -->
        <div class="grid col-5" style="gap:18px">
            <div class="card2">
                <div class="sub">Ventas/día (prom.)</div>
                <div class="kpi" id="ventasDia">—</div>
                <small class="muted" id="diasMesLbl">— días en el mes</small>
            </div>
            <div class="card2">
                <div class="sub">Días de inventario (aprox.)</div>
                <div class="kpi" id="diasInv">—</div>
                <small class="muted">≈ Inventario / (Ventas/día)</small>
            </div>
            <div class="card2">
                <div class="sub">Clasificación</div>
                <div class="kpi" id="clasificacion">—</div>
                <small class="muted" id="tips">—</small>
            </div>
        </div>
    </section>

    <!-- Detalle explicativo -->
    <section class="card col-12" style="margin-top:18px">
        <div class="row" style="gap:16px;align-items:flex-start;flex-wrap:wrap">
            <div class="col-6" style="min-width:320px">
                <h3 style="margin:0 0 8px">Notas y sugerencias</h3>
                <ul class="sub" style="margin:.25rem 0 0 1rem;line-height:1.4">
                    <li>Si la rotación está bajo la meta, revisa surtido y precios.</li>
                    <li>Prioriza promociones para categorías con menor salida.</li>
                    <li>Ajusta puntos de pedido y stock de seguridad según estacionalidad.</li>
                    <li>Usa el tablero de <b>Baja Rotación</b> para detectar productos lentos.</li>
                </ul>
            </div>
            <div class="col-6" style="min-width:320px">
                <h3 style="margin:0 0 8px">Referencia de colores</h3>
                <table class="table">
                    <thead><tr><th>Estado</th><th>Regla</th></tr></thead>
                    <tbody>
                    <tr><td><span class="pill ok">Óptima</span></td><td>>= 100% de la meta</td></tr>
                    <tr><td><span class="pill warn">Aceptable</span></td><td>70%-99% de la meta</td></tr>
                    <tr><td><span class="pill bad">Baja</span></td><td>&lt; 70% de la meta</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>
</main>

<script>
    const $ = s => document.querySelector(s);
    const fmtCLP = v => (v ?? 0).toLocaleString('es-CL',{style:'currency',currency:'CLP',maximumFractionDigits:0});
    const META_DEF = 6.0;

    const MESES = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

    function poblarFiltros(){
      // meses
      const mSel = $('#sel-mes'); mSel.innerHTML = '';
      MESES.forEach((m,i)=>{
        const opt=document.createElement('option');
        opt.value=String(i+1).padStart(2,'0'); opt.textContent=m; mSel.appendChild(opt);
      });
      // años (actual y -4)
      const ySel = $('#sel-anio'); ySel.innerHTML = '';
      const y = new Date().getFullYear();
      for(let a=y; a>=y-4; a--){
        const opt=document.createElement('option');
        opt.value=String(a); opt.textContent=String(a); ySel.appendChild(opt);
      }
      // set actuales
      const now = new Date();
      mSel.value = String(now.getMonth()+1).padStart(2,'0');
      ySel.value = String(now.getFullYear());
      $('#meta-rot').value = META_DEF.toFixed(1);
      $('#metaLabel').textContent = 'Meta: ' + META_DEF.toFixed(1) + 'x';
    }

    function diasEnMes(year, month){ return new Date(year, month, 0).getDate(); } // month 1..12

    function estadoPorMeta(rot, meta){
      const ratio = meta>0 ? rot/meta : 0;
      if(ratio >= 1.0) return {txt:'Óptima', cls:'ok'};
      if(ratio >= 0.70) return {txt:'Aceptable', cls:'warn'};
      return {txt:'Baja', cls:'bad'};
    }

    function tipPorEstado(cls){
      if(cls==='ok')   return 'Mantén niveles y reposición constante.';
      if(cls==='warn') return 'Refuerza campañas y revisa abastecimiento.';
      return            'Reduce inventario o impulsa ventas (promos, bundles).';
    }

    async function cargar(){
      try{
        $('#err').style.display='none';

        const r = await fetch('/api/dashboard/kpi1', { headers:{'Accept':'application/json'} });
        if(!r.ok) throw new Error('HTTP '+r.status);
        const d = await r.json();

        const ventas = Number(d.ventasNetas ?? 0);
        const inv    = Number(d.inventarioPromedio ?? 0);
        const rot    = (typeof d.rotacion === 'number') ? d.rotacion : (inv>0 ? ventas/inv : 0);
        const prev   = (typeof d.rotacionPrev === 'number') ? d.rotacionPrev : null;

        // selección UI
        const mesSel = Number($('#sel-mes').value);  // 1..12
        const anioSel = Number($('#sel-anio').value);
        const labelMes = `${MESES[mesSel-1]} ${anioSel}`;
        $('#tituloMes').textContent = labelMes;

        // KPI principal
        $('#rot').textContent = (rot||0).toFixed(2) + ' x';
        $('#ventas').textContent = fmtCLP(ventas);
        $('#inv').textContent    = fmtCLP(inv);

        // meta
        const meta = Math.max(0, Number($('#meta-rot').value || META_DEF));
        $('#metaLabel').textContent = 'Meta: ' + meta.toFixed(1) + 'x';

        // progreso anillo (escala hasta 150% de la meta)
        const p = Math.max(0, Math.min(rot / (meta*1.5) * 100, 100));
        $('#ring').style.setProperty('--p', p);

        // barra progreso meta (0..100%)
        const prog = Math.max(0, Math.min((meta>0 ? (rot/meta*100) : 0), 100));
        $('#bar-meta').style.width = prog.toFixed(0) + '%';

        // estado
        const est = estadoPorMeta(rot, meta);
        const estEl = $('#estado');
        estEl.textContent = est.txt;
        estEl.className = 'pill ' + est.cls;
        $('#clasificacion').textContent = est.txt;
        $('#tips').textContent = tipPorEstado(est.cls);

        // variación vs mes previo
        if(prev !== null){
          const deltaPct = (prev===0) ? 100 : ((rot - prev)/prev*100);
          const icon = (rot - prev) >= 0 ? '↑ ' : '↓ ';
          $('#var').textContent = icon + Math.abs(deltaPct).toFixed(1) + '% vs ' + (d.mesPrevio || 'previo');
        } else {
          $('#var').textContent = '—';
        }

        // anualizada
        const anual = rot * 12;
        $('#anualizada').textContent = 'Anualizada: ' + (isFinite(anual) ? anual.toFixed(1)+' x' : '—');

        // ventas por día y días de inventario
        const nDias = diasEnMes(anioSel, mesSel);
        $('#diasMesLbl').textContent = `${nDias} días en el mes`;
        const vDia = (nDias>0) ? (ventas / nDias) : 0;
        $('#ventasDia').textContent = fmtCLP(vDia);

        const dInv = (vDia>0) ? (inv / vDia) : 0;
        $('#diasInv').textContent = isFinite(dInv) ? Math.round(dInv) + ' días' : '—';

      }catch(e){
        console.error(e);
        const er = $('#err'); er.style.display='block'; er.textContent='No se pudo cargar.';
        $('#ring').style.setProperty('--p', 0);
        $('#rot').textContent='-- x'; $('#ventas').textContent='--'; $('#inv').textContent='--';
        $('#estado').textContent='—'; $('#estado').className='pill';
        $('#var').textContent='—'; $('#anualizada').textContent='Anualizada: —';
        $('#ventasDia').textContent='—'; $('#diasInv').textContent='—';
      }
    }

    function exportCSV(){
      const rows = [];
      const clean = s => String(s ?? '').replace(/"/g,'""');
      const data = {
        Mes: $('#tituloMes').textContent,
        Rotacion: $('#rot').textContent.replace(' x',''),
        VentasNetas: $('#ventas').textContent,
        InventarioPromedio: $('#inv').textContent,
        Meta: $('#meta-rot').value,
        Estado: $('#estado').textContent,
        VariacionVsPrevio: $('#var').textContent,
        RotacionAnualizada: $('#anualizada').textContent.replace('Anualizada: ',''),
        VentasPorDia: $('#ventasDia').textContent,
        DiasInventario: $('#diasInv').textContent
      };
      const header = Object.keys(data).join(',');
      const line = Object.values(data).map(v=>{
        const s = clean(v);
        return s.includes(',') ? `"${s}"` : s;
      }).join(',');
      rows.push(header); rows.push(line);
      const csv = rows.join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download='kpi-rotacion.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    // Eventos
    document.addEventListener('DOMContentLoaded', ()=>{
      poblarFiltros();
      cargar();
      $('#btn-refrescar').addEventListener('click', cargar);
      $('#meta-rot').addEventListener('change', cargar);
      $('#sel-mes').addEventListener('change', cargar);
      $('#sel-anio').addEventListener('change', cargar);
      $('#btn-export').addEventListener('click', exportCSV);
    });
</script>
</body>
</html>
