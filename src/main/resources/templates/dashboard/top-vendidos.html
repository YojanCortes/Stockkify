<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>KPI 7 — Top 5 Productos Más Vendidos</title>
    <style>
        :root { --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; }
        *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;background:linear-gradient(180deg,#0b1220,#0f172a);color:var(--text)}
        header{padding:18px 22px;border-bottom:1px solid rgba(255,255,255,.06);background:rgba(15,23,42,.85);backdrop-filter:blur(8px);position:sticky;top:0}
        .wrap{max-width:1080px;margin:0 auto;padding:22px}
        h1{margin:0;font-size:1.25rem} h2{margin:.25rem 0 1rem;color:var(--muted);font-size:.95rem}
        .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
        .list{display:grid;gap:12px}
        .row{display:flex;align-items:center;gap:10px}
        .badge{min-width:28px;height:28px;border-radius:6px;background:#334155;display:grid;place-items:center;font-weight:700}
        .bar{flex:1;height:12px;background:#334155;border-radius:999px;overflow:hidden}
        .bar>i{display:block;height:100%;background:linear-gradient(90deg,#60a5fa,#a78bfa)}
        .name{min-width:200px}
        .sub{color:var(--muted);font-size:.9rem}
        .back{display:inline-block;margin-top:18px;text-decoration:none;color:#93c5fd;border:1px solid rgba(147,197,253,.3);padding:8px 12px;border-radius:10px}
        table{width:100%;border-collapse:collapse;margin-top:16px}
        th,td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
        th{color:var(--muted);font-weight:600;font-size:.9rem}
        .filters{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
        .filters input, .filters button{
            background:#0b1220;border:1px solid rgba(255,255,255,.12);color:var(--text);
            padding:6px 10px;border-radius:8px
        }
        .filters button{cursor:pointer}
    </style>
</head>
<body>
<header><div class="wrap"><h1>KPI 7 — Top 5 Productos Más Vendidos</h1></div></header>
<main class="wrap">
    <section class="card">
        <h2>Ranking (unidades vendidas)</h2>

        <!-- Filtros de fecha (opcional; toman valores del querystring si existen) -->
        <div class="filters">
            <label class="sub">Desde <input type="date" id="desde"></label>
            <label class="sub">Hasta <input type="date" id="hasta"></label>
            <button id="btnAplicar">Aplicar</button>
            <button id="btn7d">Últimos 7 días</button>
            <button id="btn30d">Últimos 30 días</button>
            <span class="sub" id="estado">Cargando…</span>
        </div>

        <div class="list" id="ranking">
            <!-- filas -->
        </div>
        <table>
            <thead><tr><th>#</th><th>Producto</th><th>Categoría</th><th>Unidades</th></tr></thead>
            <tbody id="tabla">
            <tr><td colspan="4" class="sub">Cargando…</td></tr>
            </tbody>
        </table>
    </section>

    <section class="card" style="margin-top:16px">
        <h2>Notas</h2>
        <p class="sub" style="margin:0">
            Úsalo para reposición priorizada, exhibición y campañas. Ideal cruzar con margen para ver rentabilidad.
        </p>
    </section>

    <a class="back" href="/dhasboard-pagina">← Volver</a>
</main>

<script>
    (function () {
      const rankingEl = document.getElementById('ranking');
      const tablaEl   = document.getElementById('tabla');
      const estadoEl  = document.getElementById('estado');
      const inpDesde  = document.getElementById('desde');
      const inpHasta  = document.getElementById('hasta');
      const btnAplicar= document.getElementById('btnAplicar');
      const btn7d     = document.getElementById('btn7d');
      const btn30d    = document.getElementById('btn30d');

      function fmtDate(d){ return d.toISOString().slice(0,10); }

      // Inicializar fechas desde querystring o últimos 30 días
      const qs = new URLSearchParams(window.location.search);
      const hoy = new Date(); hoy.setHours(0,0,0,0);
      const porDefHasta = fmtDate(hoy);
      const porDefDesde = fmtDate(new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate()-30));

      inpDesde.value = qs.get('desde') || porDefDesde;
      inpHasta.value = qs.get('hasta') || porDefHasta;

      function setEstado(msg){ estadoEl.textContent = msg; }

      async function cargar() {
        setEstado('Cargando…');
        rankingEl.innerHTML = '';
        tablaEl.innerHTML = `<tr><td colspan="4" class="sub">Cargando…</td></tr>`;

        const desde = inpDesde.value || porDefDesde;
        const hasta = inpHasta.value || porDefHasta;

        try {
          const url = new URL('/api/dashboard/kpi7', window.location.origin);
          url.searchParams.set('desde', desde);
          url.searchParams.set('hasta', hasta);

          const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();

          // Soportar respuesta como {items:[...]} o directamente [...]
          const items = Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : []);

          if (items.length === 0) {
            rankingEl.innerHTML = '';
            tablaEl.innerHTML = `<tr><td colspan="4" class="sub">No hay ventas en el período seleccionado.</td></tr>`;
            setEstado('Sin datos');
            return;
          }

          // Normalizar campos
          const rows = items.map(x => ({
            nombre: x.nombre ?? x.name ?? '—',
            categoria: x.categoria ?? x.cat ?? '—',
            unidades: Number(x.unidades ?? x.units ?? 0)
          })).sort((a,b) => b.unidades - a.unidades).slice(0,5);

          const max = Math.max(1, rows[0]?.unidades ?? 1);

          // Barras (ranking visual)
          rankingEl.innerHTML = rows.map((x,i)=>`
            <div class="row">
              <div class="badge">${i+1}</div>
              <div class="name">${x.nombre}</div>
              <div class="bar"><i style="width:${Math.round(x.unidades/max*100)}%"></i></div>
              <div style="min-width:70px;text-align:right">${x.unidades.toLocaleString('es-CL')}</div>
            </div>
          `).join('');

          // Tabla
          tablaEl.innerHTML = rows.map((x,i)=>`
            <tr>
              <td>${i+1}</td>
              <td>${x.nombre}</td>
              <td>${x.categoria}</td>
              <td>${x.unidades.toLocaleString('es-CL')}</td>
            </tr>
          `).join('');

          setEstado(`Período: ${desde} a ${hasta}`);
        } catch (err) {
          console.error(err);
          rankingEl.innerHTML = '';
          tablaEl.innerHTML = `<tr><td colspan="4" class="sub">Error al cargar datos. Reintenta más tarde.</td></tr>`;
          setEstado('Error');
        }
      }

      // Botones de rango rápido
      btn7d.addEventListener('click', () => {
        const hasta = new Date(); hasta.setHours(0,0,0,0);
        const desde = new Date(hasta.getFullYear(), hasta.getMonth(), hasta.getDate()-7);
        inpDesde.value = fmtDate(desde);
        inpHasta.value = fmtDate(hasta);
        cargar();
      });

      btn30d.addEventListener('click', () => {
        const hasta = new Date(); hasta.setHours(0,0,0,0);
        const desde = new Date(hasta.getFullYear(), hasta.getMonth(), hasta.getDate()-30);
        inpDesde.value = fmtDate(desde);
        inpHasta.value = fmtDate(hasta);
        cargar();
      });

      btnAplicar.addEventListener('click', () => {
        const url = new URL(window.location.href);
        url.searchParams.set('desde', inpDesde.value);
        url.searchParams.set('hasta', inpHasta.value);
        window.history.replaceState({}, '', url);
        cargar();
      });

      // Primera carga
      cargar();
    })();
</script>
</body>
</html>
