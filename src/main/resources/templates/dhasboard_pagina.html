<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Dashboards — Operación e Inventario (MVP)</title>

    <!-- Estáticos -->
    <link th:href="@{/vendor/fontawesome-free/css/all.min.css}" rel="stylesheet"/>
    <link th:href="@{/css/sb-admin-2.min.css}" rel="stylesheet"/>

    <!-- ====== ESTILOS DASHBOARD (scope mvp-) ====== -->
    <style>
        :root{
            --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af;
            --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --primary:#60a5fa; --line:#1f2937;
        }

        /* Contenedor general del dashboard (no invade Bootstrap) */
        .mvp{ background:linear-gradient(180deg,#0b1220,#0f172a); color:var(--text); }
        .mvp *{ box-sizing:border-box; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial; }

        .mvp-header{
            padding:20px; border-bottom:1px solid rgba(255,255,255,.06);
            position:sticky; top:0; background:rgba(15,23,42,.85); backdrop-filter:blur(8px); z-index:10;
        }
        .mvp-header h1{ margin:0; font-size:1.4rem; }

        .mvp-container{ max-width:1200px; margin:0 auto; padding:24px; }

        .mvp-grid{ display:grid; grid-template-columns:repeat(12,1fr); gap:18px; }
        .mvp-col-3{ grid-column:span 3; }
        @media(max-width:1100px){ .mvp-col-3{ grid-column:span 6; } }
        @media(max-width:700px){ .mvp-col-3{ grid-column:span 12; } }

        .mvp-card{
            background:var(--card); border:1px solid rgba(255,255,255,.07); border-radius:16px;
            padding:18px; box-shadow:0 12px 30px rgba(0,0,0,.25);
            display:flex; flex-direction:column; gap:12px;
        }
        .mvp-card h2{ margin:0; font-size:1rem; color:var(--muted); font-weight:700; }

        .kpi{ font-size:1.8rem; font-weight:800; letter-spacing:-.3px; }
        .muted{ color:var(--muted); }
        .error{ color:#fda4af; font-size:.9rem; }
        .loading{ color:var(--muted); font-size:.9rem; }

        .mvp-row{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }

        .btn-mvp{
            display:inline-flex; align-items:center; justify-content:center; gap:8px;
            padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.1);
            text-decoration:none; color:#0b1020; background:#e5e7eb; font-weight:700;
        }
        .btn-mvp:hover{ filter:brightness(.95); }
        .btn-primary-mvp{ background:#93c5fd; }

        .badge-mvp{
            font-size:.8rem; padding:4px 8px; border-radius:999px;
            border:1px solid rgba(255,255,255,.1); color:#111; background:#e5e7eb;
        }

        /* Gauge circular */
        .gauge{
            --p:0; /* 0..100 */
            width:120px; height:120px; border-radius:50%;
            background:conic-gradient(var(--bad) calc(var(--p)*1%), #273244 0);
            display:grid; place-items:center; position:relative; isolation:isolate;
        }
        .gauge.ok{   background:conic-gradient(var(--ok)   calc(var(--p)*1%), #273244 0); }
        .gauge.warn{ background:conic-gradient(var(--warn) calc(var(--p)*1%), #273244 0); }
        .gauge::after{ content:""; position:absolute; inset:12px; background:var(--card); border-radius:50%; z-index:0; }
        .gauge .val{ z-index:1; font-weight:900; font-size:1.1rem; }

        /* Barras */
        .bar{ height:10px; background:#1f2937; border-radius:6px; overflow:hidden; }
        .bar>i{ display:block; height:100%; width:0; background:linear-gradient(90deg,#60a5fa,#34d399); }

        /* Rank list */
        .rank{ display:flex; flex-direction:column; gap:10px; }
        .rank-row{ display:grid; grid-template-columns:1fr 60px; gap:10px; align-items:center; }
        .rank-name{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

        .spark{ width:100%; height:64px; }

        small code{ background:rgba(255,255,255,.06); padding:2px 6px; border-radius:6px; }
    </style>
</head>

<body id="page-top">
<div id="wrapper">
    <!-- Sidebar (Thymeleaf fragment) -->
    <div th:replace="~{menugeneral :: sidebar}"></div>

    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">
        <div id="content">

            <!-- ====== DASHBOARD (sin JS) ====== -->
            <div class="mvp">
                <div class="mvp-header">
                    <div class="mvp-container">
                        <h1>Dashboards — Operación e Inventario (MVP)</h1>
                    </div>
                </div>

                <main class="mvp-container">
                    <div class="mvp-grid">

                        <!-- KPI 3 -->
                        <section class="mvp-card mvp-col-3" id="card-kpi3">
                            <h2>KPI 3 · Rupturas de Stock (%)</h2>
                            <div class="mvp-row" style="justify-content:space-between">
                                <div class="gauge" id="gauge-kpi3"><span class="val" id="gauge-val">--%</span></div>
                                <div>
                                    <div class="kpi" id="kpi3-val">--%</div>
                                    <div class="muted"><b id="kpi3-sin">--</b> sin stock / <b id="kpi3-act">--</b> activos</div>
                                    <div class="muted" id="kpi3-state">Cargando…</div>
                                    <div class="error" id="kpi3-err" style="display:none"></div>
                                </div>
                            </div>
                            <a class="btn-mvp btn-primary-mvp" href="/dashboard/rupturas">Revisar</a>
                            <small class="muted">Fórmula: <code>sin_stock / activos × 100</code></small>
                        </section>

                        <!-- KPI 4 -->
                        <section class="mvp-card mvp-col-3" id="card-kpi4">
                            <h2>KPI 4 · Valor Total de Inventario (CLP)</h2>
                            <div class="kpi" id="kpi4-total">$ --</div>
                            <div class="muted">Top categorías (muestra)</div>
                            <div class="mvp-row" style="flex-direction:column;gap:10px" id="kpi4-cats">
                                <div class="loading">Cargando…</div>
                            </div>
                            <div class="error" id="kpi4-err" style="display:none"></div>
                            <a class="btn-mvp btn-primary-mvp" href="/dashboard/valor-inventario">Revisar</a>
                            <small class="muted">Base: Σ(<code>precio × cantidad</code>)</small>
                        </section>

                        <!-- KPI 7 -->
                        <section class="mvp-card mvp-col-3" id="card-kpi7">
                            <h2>KPI 7 · Top 5 Productos Más Vendidos</h2>
                            <div class="rank" id="kpi7-rank">
                                <div class="loading">Cargando…</div>
                            </div>
                            <div class="error" id="kpi7-err" style="display:none"></div>
                            <a class="btn-mvp btn-primary-mvp" href="/dashboard/top-vendidos">Revisar</a>
                            <small class="muted">Ranking por unidades vendidas</small>
                        </section>

                        <!-- KPI 1 -->
                        <section class="mvp-card mvp-col-3" id="card-kpi1">
                            <h2>KPI 1 · Rotación de Inventario (mensual)</h2>
                            <div class="kpi" id="kpi1-rot">-- x</div>
                            <div class="muted">Ventas netas: <b id="kpi1-ventas">--</b> · Inv. prom: <b id="kpi1-inv">--</b></div>
                            <div class="mvp-row">
                                <span class="badge-mvp" id="kpi1-mes"></span>
                                <span class="badge-mvp" id="kpi1-var">—</span>
                            </div>
                            <div class="error" id="kpi1-err" style="display:none"></div>
                            <a class="btn-mvp btn-primary-mvp" href="/dashboard/rotacion">Revisar</a>
                            <small class="muted">Fórmula: <code>ventas_netas / inventario_promedio</code></small>
                        </section>

                        <!-- KPI 2 -->
                        <section class="mvp-card mvp-col-3" id="card-kpi2">
                            <h2>KPI 2 · Stock de Seguridad (%)</h2>
                            <div class="mvp-row" style="justify-content:space-between">
                                <div class="gauge" id="gauge-kpi2"><span class="val" id="gauge2-val">--%</span></div>
                                <div>
                                    <div class="kpi" id="kpi2-pct">--%</div>
                                    <div class="muted">Actual: <b id="kpi2-actual">--</b> · Mín: <b id="kpi2-min">--</b></div>
                                    <div class="muted" id="kpi2-state">Cargando…</div>
                                    <div class="error" id="kpi2-err" style="display:none"></div>
                                </div>
                            </div>
                            <a class="btn-mvp btn-primary-mvp" href="/dashboard/stock-seguridad">Revisar</a>
                            <small class="muted">Fórmula: <code>(stock_actual / stock_minimo) × 100</code></small>
                        </section>

                        <!-- KPI 5 -->
                        <section class="mvp-card mvp-col-3" id="card-kpi5">
                            <h2>KPI 5 · Productos de Baja Rotación</h2>
                            <div class="kpi"><span id="kpi5-cant">--</span> ítems</div>
                            <div class="muted">Umbral: <b id="kpi5-x">X</b> unidades/mes</div>
                            <div id="kpi5-list" class="rank" style="margin-top:6px">
                                <div class="loading">Cargando…</div>
                            </div>
                            <div class="error" id="kpi5-err" style="display:none"></div>
                            <a class="btn-mvp btn-primary-mvp" href="/dashboard/baja-rotacion">Revisar</a>
                            <small class="muted">Regla: <code>ventas_mensuales &lt; X</code></small>
                        </section>

                        <!-- KPI 6 -->
                        <section class="mvp-card mvp-col-3" id="card-kpi6">
                            <h2>KPI 6 · Stock Obsoleto (%)</h2>
                            <div class="kpi" id="kpi6-pct">--%</div>
                            <div class="muted"><b id="kpi6-obs">--</b> obsoletos / <b id="kpi6-total">--</b> productos</div>
                            <div id="kpi6-cats" style="margin-top:8px">
                                <div class="loading">Cargando…</div>
                            </div>
                            <div class="error" id="kpi6-err" style="display:none"></div>
                            <a class="btn-mvp btn-primary-mvp" href="/dashboard/stock-obsoleto">Revisar</a>
                            <small class="muted">Criterio: sin venta &gt; 60 días</small>
                        </section>

                        <!-- KPI 9 -->
                        <section class="mvp-card mvp-col-3" id="card-kpi9">
                            <h2>KPI 9 · Stock Alerts Automáticas</h2>
                            <div class="kpi"><span id="kpi9-act">--</span> alertas activas</div>
                            <div class="muted">Últimas señales</div>
                            <div id="kpi9-list" class="rank" style="margin-top:6px">
                                <div class="loading">Cargando…</div>
                            </div>
                            <div class="error" id="kpi9-err" style="display:none"></div>
                            <a class="btn-mvp btn-primary-mvp" href="/dashboard/alertas-stock">Revisar</a>
                            <small class="muted">Se activa al llegar a stock mínimo</small>
                        </section>

                        <!-- KPI 10 -->
                        <section class="mvp-card mvp-col-3" id="card-kpi10">
                            <h2>KPI 10 · Rentabilidad (margen unitario)</h2>
                            <div class="kpi" id="kpi10-prom">--%</div>
                            <div class="muted">Promedio ponderado del período</div>
                            <div class="mvp-row" style="gap:12px;margin-top:6px">
                                <div style="flex:1">
                                    <div class="muted" style="margin-bottom:4px">Top margen</div>
                                    <div id="kpi10-top" class="rank">
                                        <div class="loading">Cargando…</div>
                                    </div>
                                </div>
                                <div style="flex:1">
                                    <div class="muted" style="margin-bottom:4px">Margen bajo</div>
                                    <div id="kpi10-low" class="rank">
                                        <div class="loading">Cargando…</div>
                                    </div>
                                </div>
                            </div>
                            <div class="error" id="kpi10-err" style="display:none"></div>
                            <a class="btn-mvp btn-primary-mvp" href="/dashboard/rentabilidad">Revisar</a>
                            <small class="muted">Margen: <code>(precio_venta - costo) / precio_venta</code></small>
                        </section>

                        <!-- KPI 8 -->
                        <section class="mvp-card mvp-col-3" id="card-kpi8">
                            <h2>KPI 8 · Consumo Estimado Semanal (IA)</h2>
                            <svg class="spark" viewBox="0 0 200 64" id="kpi8-spark" aria-hidden="true"></svg>
                            <div class="mvp-row">
                                <span class="badge-mvp" id="kpi8-ultimo">Últ. semana: --</span>
                                <span class="badge-mvp" id="kpi8-tend">Tendencia: —</span>
                            </div>
                            <div class="error" id="kpi8-err" style="display:none"></div>
                            <a class="btn-mvp btn-primary-mvp" href="/dashboard/consumo-ia">Revisar</a>
                            <small class="muted">Pronóstico base (Holt amortiguado)</small>
                        </section>

                    </div>
                </main>
            </div>
            <!-- ====== FIN DASHBOARD ====== -->

        </div>
    </div>
</div>


<script>
    /* ==== Utilidades (definir ANTES de usarlas) ==== */
    const API = '/api/dashboard';
    const $   = (sel) => document.querySelector(sel);
    const fmtCLP = v => (v ?? 0).toLocaleString('es-CL', { style:'currency', currency:'CLP', maximumFractionDigits:0 });
    async function fetchJSON(url){
        const r = await fetch(url, { headers:{ 'Accept':'application/json' }});
        if(!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
    }

    /* =============================
       KPI 3 — Rupturas de stock
       ============================= */
    (async function loadKpi3() {
        try {
            const d = await fetchJSON(`${API}/kpi3`);
            const activos    = d.activos ?? d.totalActivos ?? 0;
            const sin        = d.sinStock ?? d.sin ?? 0;
            const porcentaje = (typeof d.porcentaje === 'number')
                ? d.porcentaje
                : (activos > 0 ? (sin / activos * 100) : 0);

            $('#kpi3-val').textContent = porcentaje.toFixed(1) + '%';
            $('#kpi3-sin').textContent = sin;
            $('#kpi3-act').textContent = activos;

            const g = $('#gauge-kpi3');
            g.style.setProperty('--p', porcentaje.toFixed(2));
            g.classList.remove('ok','warn','bad');
            const state = porcentaje >= 15 ? 'Crítico' : porcentaje >= 5 ? 'Atención' : 'Saludable';
            $('#kpi3-state').textContent = state;
            g.classList.add(porcentaje >= 15 ? 'bad' : porcentaje >= 5 ? 'warn' : 'ok');
            $('#gauge-val').textContent = Math.round(porcentaje) + '%';
        } catch (err) {
            console.error('KPI3 error', err);
            const e = $('#kpi3-err');
            if (e) { e.style.display = 'block'; e.textContent = 'Error al cargar KPI 3.'; }
            $('#kpi3-state').textContent = '—';
        }
    })();

    /* =============================
       KPI 4 — Valor Inventario (CLP)
       ============================= */
    (async function loadKpi4() {
        try {
            const d = await fetchJSON(`${API}/kpi4`);
            const total = (typeof d.totalValor === 'number')
                ? d.totalValor
                : (typeof d.totalValorCLP === 'number' ? d.totalValorCLP : 0);

            $('#kpi4-total').textContent = fmtCLP(total);

            const catsRaw = Array.isArray(d.categorias) ? d.categorias : [];
            const cats = catsRaw.map(c => ({
                nombre: c.categoria || 'Sin categoría',
                valor:  (typeof c.valor === 'number') ? c.valor : (typeof c.valorCLP === 'number' ? c.valorCLP : 0)
            }));

            const wrap = $('#kpi4-cats');
            if (cats.length === 0 || total <= 0) {
                wrap.innerHTML = '<div class="muted">Sin categorías con valor.</div>';
                return;
            }

            const top = cats.slice().sort((a,b) => b.valor - a.valor).slice(0, 3);
            const rows = top.map(c => ({ nombre: c.nombre, pct: Math.max(0, Math.round(c.valor * 100 / total)) }));
            const maxPct = Math.max(...rows.map(x => x.pct), 1);

            wrap.innerHTML = rows.map(({nombre, pct}) => `
          <div style="width:100%">
            <div class="row" style="justify-content:space-between">
              <span>${nombre}</span>
              <span class="muted">${pct}%</span>
            </div>
            <div class="bar"><i style="width:${(pct / maxPct * 100).toFixed(0)}%"></i></div>
          </div>
        `).join('');
        } catch (err) {
            console.error('KPI4 error', err);
            const e = $('#kpi4-err');
            if (e) { e.style.display = 'block'; e.textContent = 'Error al cargar KPI 4.'; }
            $('#kpi4-cats').innerHTML = '';
        }
    })();

    /* =============================
       KPI 7 — Top 5 más vendidos
       ============================= */
    (async function loadKpi7() {
        try {
            const arr = await fetchJSON(`${API}/kpi7`);
            const el  = $('#kpi7-rank');

            if (!Array.isArray(arr) || arr.length === 0) {
                el.innerHTML = '<div class="muted">Sin datos en el período.</div>';
                return;
            }
            const max = Math.max(...arr.map(x => x.unidades || 0), 1);

            el.innerHTML = arr.map(x => `
          <div class="rank-row">
            <div class="row" style="gap:10px;align-items:center;width:100%">
              <div class="rank-name" title="${(x.nombre || '').replace(/"/g,'&quot;')}">${x.nombre || '-'}</div>
              <div class="bar" style="flex:1">
                <i style="width:${((x.unidades || 0) / max * 100).toFixed(0)}%"></i>
              </div>
            </div>
            <div class="muted" style="text-align:right">${x.unidades || 0}</div>
          </div>
        `).join('');
        } catch (err) {
            console.error('KPI7 error', err);
            const e = $('#kpi7-err');
            if (e) { e.style.display = 'block'; e.textContent = 'Error al cargar KPI 7.'; }
            $('#kpi7-rank').innerHTML = '';
        }
    })();

    /* =============================
       KPI 1 — Rotación mensual
       ============================= */
    (async function loadKpi1(){
        try{
            const d = await fetchJSON(`${API}/kpi1`);
            const ventas = d.ventasNetas ?? 0;
            const inv    = d.inventarioPromedio ?? 0;
            const rot    = (typeof d.rotacion === 'number') ? d.rotacion : (inv>0?(ventas/inv):0);
            const rotPrev= (typeof d.rotacionPrev === 'number') ? d.rotacionPrev : null;

            $('#kpi1-rot').textContent = (rot || 0).toFixed(2) + ' x';
            $('#kpi1-ventas').textContent = fmtCLP(ventas);
            $('#kpi1-inv').textContent = fmtCLP(inv);
            $('#kpi1-mes').textContent = (d.mesActual || 'Mes actual');

            let varTxt = '—';
            if (rotPrev !== null){
                const varPct = rotPrev===0 ? 100 : ((rot - rotPrev) / (rotPrev||1)) * 100;
                varTxt = (varPct>=0?'↑ ':'↓ ') + Math.abs(varPct).toFixed(1) + '% vs ' + (d.mesPrevio || 'previo');
            }
            $('#kpi1-var').textContent = varTxt;
        }catch(err){
            console.error('KPI1 error', err);
            const e = $('#kpi1-err'); e.style.display='block'; e.textContent='Error al cargar KPI 1.';
        }
    })();

    /* =============================
       KPI 2 — Stock de seguridad (%)
       ============================= */
    (async function loadKpi2(){
        try{
            const d = await fetchJSON(`${API}/kpi2`);
            const actual = d.stockActual ?? 0;
            const minimo = d.stockMinimo ?? 0;
            const pct    = (typeof d.porcentaje === 'number') ? d.porcentaje : (minimo>0?(actual/minimo*100):0);

            $('#kpi2-pct').textContent = pct.toFixed(1) + '%';
            $('#kpi2-actual').textContent = actual;
            $('#kpi2-min').textContent = minimo;

            const g = $('#gauge-kpi2');
            g.style.setProperty('--p', Math.max(0, Math.min(100, pct)).toFixed(2));
            g.classList.remove('ok','warn','bad');

            let state = '—', cls='ok';
            if (pct >= 100){ state='Saludable'; cls='ok'; }
            else if (pct >= 80){ state='Atención'; cls='warn'; }
            else { state='Crítico'; cls='bad'; }
            $('#kpi2-state').textContent = state;
            g.classList.add(cls);
            $('#gauge2-val').textContent = Math.round(pct) + '%';
        }catch(err){
            console.error('KPI2 error', err);
            const e = $('#kpi2-err'); e.style.display='block'; e.textContent='Error al cargar KPI 2.';
        }
    })();

    /* =============================
       KPI 5 — Baja rotación (usa /baja-rotacion)
       ============================= */
    (async function loadKpi5(){
        try{
            // Tomamos sólo una muestra chica para la tarjeta
            const d = await fetchJSON(`${API}/baja-rotacion?size=5`);
            const umbral = d.umbral ?? 5;
            const total  = d.total ?? 0;
            const arr    = Array.isArray(d.productos)? d.productos : [];

            $('#kpi5-x').textContent = umbral;
            $('#kpi5-cant').textContent = total;

            const el = $('#kpi5-list');
            if (arr.length===0){ el.innerHTML = '<div class="muted">Sin ítems bajo el umbral.</div>'; return; }

            const max = Math.max(...arr.map(x => x.ventasMensuales||0), 1);
            el.innerHTML = arr.map(x => `
          <div class="rank-row">
            <div class="row" style="gap:10px;align-items:center;width:100%">
              <div class="rank-name" title="${(x.nombre||'-').replace(/"/g,'&quot;')}">${x.nombre||'-'}</div>
              <div class="bar" style="flex:1"><i style="width:${((x.ventasMensuales||0)/max*100).toFixed(0)}%"></i></div>
            </div>
            <div class="muted" style="text-align:right">${x.ventasMensuales||0}</div>
          </div>
        `).join('');
        }catch(err){
            console.error('KPI5 error', err);
            const e = $('#kpi5-err'); e.style.display='block'; e.textContent='Error al cargar KPI 5.';
            $('#kpi5-list').innerHTML='';
        }
    })();

    /* =============================
       KPI 6 — % Stock obsoleto (>60d sin venta)
       ============================= */
    (async function loadKpi6(){
        try{
            const d = await fetchJSON(`${API}/kpi6`);
            const obs = d.obsoletos ?? 0;
            const tot = d.total ?? 0;
            const pct = (typeof d.porcentaje==='number') ? d.porcentaje : (tot>0?(obs/tot*100):0);

            $('#kpi6-pct').textContent = pct.toFixed(1) + '%';
            $('#kpi6-obs').textContent = obs;
            $('#kpi6-total').textContent = tot;

            const cats = Array.isArray(d.categorias)? d.categorias : [];
            const wrap = $('#kpi6-cats');
            if (cats.length===0){ wrap.innerHTML = '<div class="muted">Sin concentración por categoría.</div>'; return; }

            const top = cats.slice().sort((a,b)=>(b.pct||0)-(a.pct||0)).slice(0,3);
            const max = Math.max(...top.map(x => x.pct||0),1);

            wrap.innerHTML = top.map(c => `
          <div style="width:100%">
            <div class="row" style="justify-content:space-between">
              <span>${c.nombre||'-'}</span>
              <span class="muted">${(c.pct||0).toFixed(0)}%</span>
            </div>
            <div class="bar"><i style="width:${(((c.pct||0)/max)*100).toFixed(0)}%"></i></div>
          </div>
        `).join('');
        }catch(err){
            console.error('KPI6 error', err);
            const e = $('#kpi6-err'); e.style.display='block'; e.textContent='Error al cargar KPI 6.';
            $('#kpi6-cats').innerHTML='';
        }
    })();

    /* =============================
       KPI 9 — Alertas de stock
       (Derivado de /kpi3/detalle como demo)
       ============================= */
    (async function loadKpi9(){
        try{
            // Reutilizamos productos sin stock como "alertas"
            const arr = await fetchJSON(`${API}/kpi3/detalle`);
            const items = Array.isArray(arr) ? arr : [];
            $('#kpi9-act').textContent = items.length;

            const el = $('#kpi9-list');
            if (items.length===0){ el.innerHTML = '<div class="muted">Sin señales recientes.</div>'; return; }

            el.innerHTML = items.slice(0,5).map(x=>{
                const nombre = (x.nombre || '-').replace(/"/g,'&quot;');
                const estadoTxt = 'Mínimo';
                return `
            <div class="rank-row">
              <div class="rank-name" title="${nombre}">${nombre}</div>
              <div style="text-align:right">
                <span class="badge">${estadoTxt}</span>
              </div>
            </div>
          `;
            }).join('');
        }catch(err){
            console.error('KPI9 error', err);
            const e = $('#kpi9-err'); e.style.display='block'; e.textContent='Error al cargar KPI 9.';
            $('#kpi9-list').innerHTML='';
        }
    })();

    /* =============================
       KPI 10 — Rentabilidad (margen)
       ============================= */
    (async function loadKpi10(){
        try{
            const d = await fetchJSON(`${API}/kpi10`);
            const prom = d.margenPromedioPct ?? 0;
            $('#kpi10-prom').textContent = (prom).toFixed(1) + '%';

            const top = Array.isArray(d.top)? d.top.slice(0,5) : [];
            const low = Array.isArray(d.low)? d.low.slice(0,5) : [];

            const maxTop = Math.max(...top.map(x=>Math.abs(x.margenPct||0)), 1);
            const maxLow = Math.max(...low.map(x=>Math.abs(x.margenPct||0)), 1);

            const toRow = (x, max) => `
          <div class="rank-row">
            <div class="row" style="gap:10px;align-items:center;width:100%">
              <div class="rank-name" title="${(x.nombre||'-').replace(/"/g,'&quot;')}">${x.nombre||'-'}</div>
              <div class="bar" style="flex:1"><i style="width:${(Math.abs(x.margenPct||0)/max*100).toFixed(0)}%"></i></div>
            </div>
            <div class="muted" style="text-align:right">${(x.margenPct||0).toFixed(1)}%</div>
          </div>
        `;

            $('#kpi10-top').innerHTML = top.length? top.map(x=>toRow(x,maxTop)).join('') : '<div class="muted">—</div>';
            $('#kpi10-low').innerHTML = low.length? low.map(x=>toRow(x,maxLow)).join('') : '<div class="muted">—</div>';
        }catch(err){
            console.error('KPI10 error', err);
            const e = $('#kpi10-err'); e.style.display='block'; e.textContent='Error al cargar KPI 10.';
            $('#kpi10-top').innerHTML=''; $('#kpi10-low').innerHTML='';
        }
    })();

    /* =============================
       KPI 8 — Consumo semanal (hist + forecast)
       ============================= */
    function drawSpark(hist, fcst) {
        const svg = $('#kpi8-spark');
        const w = 200, h = 64, p = 6;

        const serieH = hist.map(x => x.unidades || 0);
        const serieF = fcst.map(x => x.unidades || 0);
        const data   = serieH.concat(serieF);

        if (data.length < 2) { svg.innerHTML = ''; return; }

        const min = Math.min(...data);
        const max = Math.max(...data);
        const xr  = (i) => p + i * ((w - 2 * p) / (data.length - 1));
        const yr  = (v) => h - p - ((v - min) / (max - min || 1)) * (h - 2 * p);

        let dH = '', dF = '';
        serieH.forEach((v, i) => dH += (i ? 'L' : 'M') + xr(i) + ',' + yr(v) + ' ');
        serieF.forEach((v, i) => {
            const idx = serieH.length - 1 + i;
            dF += (i ? 'L' : 'M') + xr(idx) + ',' + yr(v) + ' ';
        });

        svg.innerHTML = `
        <defs>
          <linearGradient id="g1" x1="0" x2="0" y1="0" y2="1">
            <stop offset="0%" stop-color="#60a5fa" stop-opacity="0.35"/>
            <stop offset="100%" stop-color="#60a5fa" stop-opacity="0"/>
          </linearGradient>
        </defs>
        <path d="${dH}" fill="none" stroke="#60a5fa" stroke-width="2"/>
        <path d="${dH} L ${w-p},${h-p} L ${p},${h-p} Z" fill="url(#g1)" opacity=".4"/>
        ${dF ? `<path d="${dF}" fill="none" stroke="#34d399" stroke-width="2" stroke-dasharray="4 3"/>` : ''}
        <rect x="0" y="${h-1}" width="${w}" height="1" fill="#1f2937"/>
      `;
    }

    (async function loadKpi8() {
        try {
            // 12 semanas de histórico + 4 de horizonte
            const dto  = await fetchJSON(`${API}/kpi8?semanas=12&h=4`);
            const hist = Array.isArray(dto.historico) ? dto.historico : [];
            const fcst = Array.isArray(dto.forecast)  ? dto.forecast  : [];

            drawSpark(hist, fcst);

            // Badges: última semana histórica y tendencia
            const lastHist = hist.length ? (hist[hist.length - 1].unidades || 0) : 0;
            let tendencia;

            if (fcst.length && typeof fcst[0].unidades === 'number') {
                const next1 = fcst[0].unidades;
                tendencia = next1 >= lastHist ? '↑ alza' : '↓ baja';
            } else if (hist.length >= 2) {
                const prev = hist[hist.length - 2].unidades || 0;
                tendencia = lastHist >= prev ? '↑ alza' : '↓ baja';
            } else {
                tendencia = '—';
            }

            $('#kpi8-ultimo').textContent = `Últ. semana: ${lastHist}`;
            $('#kpi8-tend').textContent   = `Tendencia: ${tendencia}`;
        } catch (err) {
            console.error('KPI8 error', err);
            const e = $('#kpi8-err');
            if (e) { e.style.display = 'block'; e.textContent = 'Error al cargar KPI 8.'; }
            $('#kpi8-spark').innerHTML = '';
            $('#kpi8-ultimo').textContent = 'Últ. semana: —';
            $('#kpi8-tend').textContent   = 'Tendencia: —';
        }
    })();
</script>
</body>
</html>