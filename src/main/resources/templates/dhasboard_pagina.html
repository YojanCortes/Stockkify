<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Dashboards — Operación e Inventario (MVP)</title>

    <style>
        :root{
          --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af;
          --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --primary:#60a5fa; --line:#1f2937;
        }
        *{box-sizing:border-box}
        body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial;background:linear-gradient(180deg,#0b1220,#0f172a);color:var(--text)}
        header{padding:20px;border-bottom:1px solid rgba(255,255,255,.06);position:sticky;top:0;background:rgba(15,23,42,.85);backdrop-filter:blur(8px)}
        .container{max-width:1200px;margin:0 auto;padding:24px}
        h1{margin:0;font-size:1.4rem}
        .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:18px}
        .col-3{grid-column:span 3}
        @media(max-width:1100px){.col-3{grid-column:span 6}}
        @media(max-width:700px){.col-3{grid-column:span 12}}

        .card{background:var(--card);border:1px solid rgba(255,255,255,.07);border-radius:16px;padding:18px;box-shadow:0 12px 30px rgba(0,0,0,.25);display:flex;flex-direction:column;gap:12px}
        .card h2{margin:0;font-size:1rem;color:var(--muted);font-weight:700}
        .kpi{font-size:1.8rem;font-weight:800;letter-spacing:-.3px}
        .muted{color:var(--muted)}
        .row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
        .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.1);text-decoration:none;color:#0b1020;background:#e5e7eb;font-weight:700}
        .btn:hover{filter:brightness(.95)}
        .btn-primary{background:#93c5fd}
        .badge{font-size:.8rem;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.1);color:#111;background:#e5e7eb}

        /* KPI3 – gauge circular */
        .gauge{
          --p:0; /* 0..100 */
          width:120px;height:120px;border-radius:50%;
          background:conic-gradient(var(--bad) calc(var(--p)*1%), #273244 0);
          display:grid;place-items:center;position:relative;isolation:isolate
        }
        .gauge.ok{background:conic-gradient(var(--ok) calc(var(--p)*1%), #273244 0)}
        .gauge.warn{background:conic-gradient(var(--warn) calc(var(--p)*1%), #273244 0)}
        .gauge::after{content:"";position:absolute;inset:12px;background:var(--card);border-radius:50%;z-index:0}
        .gauge .val{z-index:1;font-weight:900;font-size:1.1rem}

        /* Barras simples */
        .bar{height:10px;background:#1f2937;border-radius:6px;overflow:hidden}
        .bar > i{display:block;height:100%;width:0;background:linear-gradient(90deg,#60a5fa,#34d399)}

        /* Lista ranking */
        .rank{display:flex;flex-direction:column;gap:10px}
        .rank-row{display:grid;grid-template-columns:1fr 60px;gap:10px;align-items:center}
        .rank-name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .spark{width:100%;height:64px}

        .error{color:#fda4af;font-size:.9rem}
        .loading{color:var(--muted);font-size:.9rem}
        small code{background:rgba(255,255,255,.06);padding:2px 6px;border-radius:6px}
    </style>
</head>
<body>
<header><div class="container"><h1>Dashboards — Operación e Inventario (MVP)</h1></div></header>

<main class="container">
    <div class="grid">
        <!-- === KPI 3: Rupturas de Stock (%) === -->
        <section class="card col-3" id="card-kpi3">
            <h2>KPI 3 · Rupturas de Stock (%)</h2>
            <div class="row" style="justify-content:space-between">
                <div class="gauge" id="gauge-kpi3"><span class="val" id="gauge-val">--%</span></div>
                <div>
                    <div class="kpi" id="kpi3-val">--%</div>
                    <div class="muted"><b id="kpi3-sin">--</b> sin stock / <b id="kpi3-act">--</b> activos</div>
                    <div class="muted" id="kpi3-state">Cargando…</div>
                    <div class="error" id="kpi3-err" style="display:none"></div>
                </div>
            </div>
            <a class="btn btn-primary" href="/dashboard/rupturas">Revisar</a>
            <small class="muted">Fórmula: <code>sin_stock / activos × 100</code></small>
        </section>

        <!-- === KPI 4: Valor Total de Inventario (CLP) === -->
        <section class="card col-3" id="card-kpi4">
            <h2>KPI 4 · Valor Total de Inventario (CLP)</h2>
            <div class="kpi" id="kpi4-total">$ --</div>
            <div class="muted">Top categorías (muestra)</div>
            <div class="row" style="flex-direction:column;gap:10px" id="kpi4-cats">
                <div class="loading">Cargando…</div>
            </div>
            <div class="error" id="kpi4-err" style="display:none"></div>
            <a class="btn btn-primary" href="/dashboard/valor-inventario">Revisar</a>
            <small class="muted">Base: Σ(<code>precio × cantidad</code>)</small>
        </section>

        <!-- === KPI 7: Top 5 Productos Más Vendidos === -->
        <section class="card col-3" id="card-kpi7">
            <h2>KPI 7 · Top 5 Productos Más Vendidos</h2>
            <div class="rank" id="kpi7-rank">
                <div class="loading">Cargando…</div>
            </div>
            <div class="error" id="kpi7-err" style="display:none"></div>
            <a class="btn btn-primary" href="/dashboard/top-vendidos">Revisar</a>
            <small class="muted">Ranking por unidades vendidas</small>
        </section>

        <!-- === KPI 8: Consumo Estimado Semanal (IA) === -->
        <section class="card col-3" id="card-kpi8">
            <h2>KPI 8 · Consumo Estimado Semanal (IA)</h2>
            <svg class="spark" viewBox="0 0 200 64" id="kpi8-spark" aria-hidden="true"></svg>
            <div class="row">
                <span class="badge" id="kpi8-ultimo">Últ. semana: --</span>
                <span class="badge" id="kpi8-tend">Tendencia: —</span>
            </div>
            <div class="error" id="kpi8-err" style="display:none"></div>
            <a class="btn btn-primary" href="/dashboard/consumo-ia">Revisar</a>
            <small class="muted">Pronóstico base (Holt amortiguado)</small>
        </section>
    </div>
</main>

<script>
    // =============================
    // Utilidades
    // =============================
    const API   = '/api/dashboard';
    const $     = (sel) => document.querySelector(sel);
    const fmtCLP = v => (v ?? 0).toLocaleString('es-CL', {
      style: 'currency', currency: 'CLP', maximumFractionDigits: 0
    });

    async function fetchJSON(url) {
      const r = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    }

    // =============================
    // KPI 3 — Rupturas de stock
    // =============================
    (async function loadKpi3() {
      try {
        const d = await fetchJSON(`${API}/kpi3`);
        const activos    = d.activos ?? d.totalActivos ?? 0;
        const sin        = d.sinStock ?? d.sin ?? 0;
        const porcentaje = (typeof d.porcentaje === 'number')
          ? d.porcentaje
          : (activos > 0 ? (sin / activos * 100) : 0);

        $('#kpi3-val').textContent = porcentaje.toFixed(1) + '%';
        $('#kpi3-sin').textContent = sin;
        $('#kpi3-act').textContent = activos;

        const g = $('#gauge-kpi3');
        g.style.setProperty('--p', porcentaje.toFixed(2));
        g.classList.remove('ok','warn','bad');
        const state = porcentaje >= 15 ? 'Crítico' : porcentaje >= 5 ? 'Atención' : 'Saludable';
        $('#kpi3-state').textContent = state;
        g.classList.add(porcentaje >= 15 ? 'bad' : porcentaje >= 5 ? 'warn' : 'ok');
        $('#gauge-val').textContent = Math.round(porcentaje) + '%';
      } catch (err) {
        console.error('KPI3 error', err);
        const e = $('#kpi3-err');
        if (e) {
          e.style.display = 'block';
          e.textContent = 'Error al cargar KPI 3.';
        }
        $('#kpi3-state').textContent = '—';
      }
    })();

    // =============================
    // KPI 4 — Valor Inventario (CLP)
    // Acepta DTO con { totalValorCLP, categorias[].valorCLP }
    // o la variante { totalValor, categorias[].valor }
    // =============================
    (async function loadKpi4() {
      try {
        const d = await fetchJSON(`${API}/kpi4`);

        // Normalización de nombres
        const total = (typeof d.totalValor === 'number')
          ? d.totalValor
          : (typeof d.totalValorCLP === 'number' ? d.totalValorCLP : 0);

        $('#kpi4-total').textContent = fmtCLP(total);

        const catsRaw = Array.isArray(d.categorias) ? d.categorias : [];
        const cats = catsRaw.map(c => ({
          nombre: c.categoria || 'Sin categoría',
          valor:  (typeof c.valor === 'number')
                    ? c.valor
                    : (typeof c.valorCLP === 'number' ? c.valorCLP : 0)
        }));

        const wrap = $('#kpi4-cats');
        if (cats.length === 0 || total <= 0) {
          wrap.innerHTML = '<div class="muted">Sin categorías con valor.</div>';
          return;
        }

        const top = cats.slice().sort((a,b) => b.valor - a.valor).slice(0, 3);
        const rows = top.map(c => ({
          nombre: c.nombre,
          pct: Math.max(0, Math.round(c.valor * 100 / total))
        }));
        const maxPct = Math.max(...rows.map(x => x.pct), 1);

        wrap.innerHTML = rows.map(({nombre, pct}) => `
          <div style="width:100%">
            <div class="row" style="justify-content:space-between">
              <span>${nombre}</span>
              <span class="muted">${pct}%</span>
            </div>
            <div class="bar"><i style="width:${(pct / maxPct * 100).toFixed(0)}%"></i></div>
          </div>
        `).join('');
      } catch (err) {
        console.error('KPI4 error', err);
        const e = $('#kpi4-err');
        if (e) {
          e.style.display = 'block';
          e.textContent = 'Error al cargar KPI 4.';
        }
        $('#kpi4-cats').innerHTML = '';
      }
    })();

    // =============================
    // KPI 7 — Top 5 más vendidos (últimos 30 días por defecto)
    // =============================
    (async function loadKpi7() {
      try {
        const arr = await fetchJSON(`${API}/kpi7`);
        const el  = $('#kpi7-rank');

        if (!Array.isArray(arr) || arr.length === 0) {
          el.innerHTML = '<div class="muted">Sin datos en el período.</div>';
          return;
        }
        const max = Math.max(...arr.map(x => x.unidades || 0), 1);

        el.innerHTML = arr.map(x => `
          <div class="rank-row">
            <div class="row" style="gap:10px;align-items:center;width:100%">
              <div class="rank-name" title="${(x.nombre || '').replace(/"/g,'&quot;')}">${x.nombre || '-'}</div>
              <div class="bar" style="flex:1">
                <i style="width:${((x.unidades || 0) / max * 100).toFixed(0)}%"></i>
              </div>
            </div>
            <div class="muted" style="text-align:right">${x.unidades || 0}</div>
          </div>
        `).join('');
      } catch (err) {
        console.error('KPI7 error', err);
        const e = $('#kpi7-err');
        if (e) {
          e.style.display = 'block';
          e.textContent = 'Error al cargar KPI 7.';
        }
        $('#kpi7-rank').innerHTML = '';
      }
    })();

    // =============================
    // KPI 8 — Consumo semanal (hist + forecast)
    // =============================
    function drawSpark(hist, fcst) {
      const svg = $('#kpi8-spark');
      const w = 200, h = 64, p = 6;

      const serieH = hist.map(x => x.unidades || 0);
      const serieF = fcst.map(x => x.unidades || 0);
      const data   = serieH.concat(serieF);

      if (data.length < 2) { svg.innerHTML = ''; return; }

      const min = Math.min(...data);
      const max = Math.max(...data);
      const xr  = (i) => p + i * ((w - 2 * p) / (data.length - 1));
      const yr  = (v) => h - p - ((v - min) / (max - min || 1)) * (h - 2 * p);

      let dH = '', dF = '';
      serieH.forEach((v, i) => dH += (i ? 'L' : 'M') + xr(i) + ',' + yr(v) + ' ');
      serieF.forEach((v, i) => {
        const idx = serieH.length - 1 + i;
        dF += (i ? 'L' : 'M') + xr(idx) + ',' + yr(v) + ' ';
      });

      svg.innerHTML = `
        <defs>
          <linearGradient id="g1" x1="0" x2="0" y1="0" y2="1">
            <stop offset="0%" stop-color="#60a5fa" stop-opacity="0.35"/>
            <stop offset="100%" stop-color="#60a5fa" stop-opacity="0"/>
          </linearGradient>
        </defs>
        <path d="${dH}" fill="none" stroke="#60a5fa" stroke-width="2"/>
        <path d="${dH} L ${w-p},${h-p} L ${p},${h-p} Z" fill="url(#g1)" opacity=".4"/>
        ${dF ? `<path d="${dF}" fill="none" stroke="#34d399" stroke-width="2" stroke-dasharray="4 3"/>` : ''}
        <rect x="0" y="${h-1}" width="${w}" height="1" fill="#1f2937"/>
      `;
    }

    (async function loadKpi8() {
      try {
        // 12 semanas de histórico + 4 de horizonte
        const dto  = await fetchJSON(`${API}/kpi8?semanas=12&h=4`);
        const hist = Array.isArray(dto.historico) ? dto.historico : [];
        const fcst = Array.isArray(dto.forecast)  ? dto.forecast  : [];

        drawSpark(hist, fcst);

        // Badges: última semana histórica y tendencia (forecast o fallback histórico)
        const lastHist = hist.length ? (hist[hist.length - 1].unidades || 0) : 0;
        let tendencia;

        if (fcst.length && typeof fcst[0].unidades === 'number') {
          const next1 = fcst[0].unidades;
          tendencia = next1 >= lastHist ? '↑ alza' : '↓ baja';
        } else if (hist.length >= 2) {
          const prev = hist[hist.length - 2].unidades || 0;
          tendencia = lastHist >= prev ? '↑ alza' : '↓ baja';
        } else {
          tendencia = '—';
        }

        $('#kpi8-ultimo').textContent = `Últ. semana: ${lastHist}`;
        $('#kpi8-tend').textContent   = `Tendencia: ${tendencia}`;
      } catch (err) {
        console.error('KPI8 error', err);
        const e = $('#kpi8-err');
        if (e) {
          e.style.display = 'block';
          e.textContent = 'Error al cargar KPI 8.';
        }
        $('#kpi8-spark').innerHTML = '';
        $('#kpi8-ultimo').textContent = 'Últ. semana: —';
        $('#kpi8-tend').textContent   = 'Tendencia: —';
      }
    })();
</script>



</body>
</html>
