<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title th:text="${form.rut != null} ? 'Editar empleado' : 'Nuevo empleado'">Empleado</title>

    <!-- CSRF para AJAX -->
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">

    <link th:href="@{/vendor/fontawesome-free/css/all.min.css}" rel="stylesheet"/>
    <link th:href="@{/css/sb-admin-2.min.css}" rel="stylesheet"/>
    <style>
        .modal-header-success { background:#28a745; color:#fff; }
        .modal-header-error   { background:#dc3545; color:#fff; }
    </style>
</head>
<body id="page-top">
<div id="wrapper">
    <!-- Sidebar -->
    <div th:replace="~{menugeneral :: sidebar}"></div>

    <div id="content-wrapper" class="d-flex flex-column">
        <div id="content">

            <!-- Topbar -->
            <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
                <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
                    <i class="fa fa-bars"></i>
                </button>
                <span class="navbar-text font-weight-bold" th:text="${form.rut != null} ? 'Editar empleado' : 'Nuevo empleado'">Empleado</span>
                <ul class="navbar-nav ml-auto"></ul>
            </nav>

            <div class="container-fluid">
                <div class="d-sm-flex align-items-center justify-content-between mb-3">
                    <h1 class="h3 mb-0 text-gray-800">Registro empleados</h1>
                    <a class="btn btn-secondary btn-sm" th:href="@{/empleados}">
                        <i class="fas fa-list mr-1"></i> Volver a la lista
                    </a>
                </div>

                <div class="row">
                    <div class="col-lg-12">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3 d-flex align-items-center">
                                <i class="fas fa-user-edit mr-2 text-primary"></i>
                                <h6 class="m-0 font-weight-bold text-primary"
                                    th:text="${form.rut != null} ? 'Editar datos' : 'Nuevo empleado'">Formulario</h6>
                            </div>
                            <div class="card-body">

                                <!-- FORM -->
                                <form id="empleadoForm"
                                      th:with="rutVal=${form.rut}, actionUrl=${rutVal} != null ? '/empleados/' + ${rutVal} : '/empleados', isEdit=${rutVal} != null"
                                      th:attr="data-action-url=${actionUrl}, data-edit=${isEdit}"
                                      th:object="${form}"
                                      method="post">

                                    <!-- CSRF fallback -->
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                                    <!-- RUT -->
                                    <div class="form-row">
                                        <!-- RUT -->
                                        <div class="form-group col-md-6">
                                            <label for="rut">RUT</label>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text"><i class="far fa-id-card"></i></span>
                                                </div>
                                                <input id="rut" type="text" class="form-control" placeholder="12.345.678-9"
                                                       th:field="*{rut}">
                                            </div>
                                            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('rut')}" th:errors="*{rut}">Error</div>
                                        </div>

                                    </div>

                                    <!-- Nombre + Email -->
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="nombre">Nombre completo</label>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                                                </div>
                                                <input id="nombre" type="text" class="form-control" placeholder="Nombre y Apellido"
                                                       th:field="*{nombre}">
                                            </div>
                                            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('nombre')}"
                                                 th:errors="*{nombre}">Error</div>
                                        </div>

                                        <div class="form-group col-md-6">
                                            <label for="email">Email</label>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                                </div>
                                                <input id="email" type="email" class="form-control" placeholder="correo@empresa.com"
                                                       th:field="*{email}">
                                            </div>
                                            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('email')}"
                                                 th:errors="*{email}">Error</div>
                                        </div>
                                    </div>

                                    <!-- Teléfono + Rol -->
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="telefono">Teléfono</label>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                                </div>
                                                <input id="telefono" type="text" class="form-control" placeholder="Ej. +56 9 9999 9999"
                                                       th:field="*{telefono}">
                                            </div>
                                            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('telefono')}"
                                                 th:errors="*{telefono}">Error</div>
                                        </div>

                                        <div class="form-group col-md-6">
                                            <label for="rol">Rol</label>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text"><i class="fas fa-user-shield"></i></span>
                                                </div>
                                                <select id="rol" class="form-control" th:field="*{rol}">
                                                    <option value="" disabled th:selected="${form.rol == null}">Selecciona un rol…</option>
                                                    <option th:each="r : ${roles}" th:value="${r}" th:text="${r}">ROL</option>
                                                </select>
                                            </div>
                                            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('rol')}"
                                                 th:errors="*{rol}">Error</div>
                                        </div>
                                    </div>

                                    <!-- Password + Confirmación -->
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="password" th:text="${form.rut != null} ? 'Nueva contraseña (opcional)' : 'Contraseña'">Contraseña</label>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                                </div>
                                                <input id="password" type="password" class="form-control" placeholder="••••••••"
                                                       th:field="*{password}">
                                            </div>
                                            <small class="form-text text-muted" th:if="${form.rut != null}">
                                                Déjalo vacío para no cambiarla.
                                            </small>
                                            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('password')}"
                                                 th:errors="*{password}">Error</div>
                                        </div>

                                        <div class="form-group col-md-6">
                                            <label for="confirmPassword">Confirmar contraseña</label>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                                </div>
                                                <input id="confirmPassword" type="password" class="form-control" placeholder="Repite la contraseña"
                                                       th:field="*{confirmPassword}">
                                            </div>
                                            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('confirmPassword')}"
                                                 th:errors="*{confirmPassword}">Error</div>
                                        </div>
                                    </div>

                                    <!-- Botones -->
                                    <div class="mt-3 d-flex">
                                        <button id="btnGuardar" type="submit" class="btn btn-success mr-2">
                                            <i class="fas fa-save mr-1"></i>
                                            <span th:text="${form.rut != null} ? 'Guardar cambios' : 'Crear empleado'">Guardar</span>
                                        </button>
                                        <a class="btn btn-danger" th:href="@{/empleados}">
                                            <i class="fas fa-times mr-1"></i> Cancelar
                                        </a>
                                    </div>
                                </form>

                            </div>
                        </div>
                    </div>
                </div>

            </div><!-- /.container-fluid -->
        </div>

        <footer class="sticky-footer bg-white">
            <div class="container my-auto">
                <div class="copyright text-center my-auto"><span>&copy; Inventario 2025</span></div>
            </div>
        </footer>
    </div>
</div>

<!-- ====== MODAL ÉXITO ====== -->
<div class="modal fade" id="modalSuccess" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-success">
                <h5 class="modal-title"><i class="fas fa-check-circle mr-2"></i> Operación exitosa</h5>
            </div>
            <div class="modal-body">
                <p class="mb-0">Usuario registrado correctamente.</p>
            </div>
        </div>
    </div>
</div>

<!-- ====== MODAL ERROR ====== -->
<div class="modal fade" id="modalError" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-error">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle mr-2"></i> Error al guardar</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Cerrar">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p class="mb-2">Ocurrió un problema al guardar los datos. Revisa los campos o inténtalo de nuevo.</p>
                <pre id="modalErrorDetail" class="small mb-0" style="white-space:pre-wrap;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<a class="scroll-to-top rounded" href="#page-top"><i class="fas fa-angle-up"></i></a>

<script th:src="@{/vendor/jquery/jquery.min.js}"></script>
<script th:src="@{/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/vendor/jquery-easing/jquery.easing.min.js}"></script>
<script th:src="@{/js/sb-admin-2.min.js}"></script>

<script>
    (function () {
        const $form = $('#empleadoForm');
        if ($form.length === 0) return;

        const actionUrl = $form.data('action-url');
        const isEdit    = String($form.data('edit')) === 'true';
        const $btn      = $('#btnGuardar');

        // ====== RUT helpers ======
        function cleanRut(v){ return (v || '').replace(/[.\-\s]/g, '').toUpperCase(); }
        function dv(num){
            let s = 0, f = 2;
            for (let i = num.length - 1; i >= 0; i--) {
                s += parseInt(num[i], 10) * f;
                f = (f === 7) ? 2 : f + 1;
            }
            const r = 11 - (s % 11);
            return r === 11 ? '0' : (r === 10 ? 'K' : String(r));
        }
        // Acepta: (a) sólo dígitos 4..12 (modo pruebas) o (b) con DV válido
        function isRutAcceptable(v){
            const r = cleanRut(v);
            if (!r) return false;
            if (/^\d{4,12}$/.test(r)) return true; // solo dígitos (pruebas)
            if (r.length < 2) return false;
            const body = r.slice(0, -1), d = r.slice(-1);
            if (!/^\d+$/.test(body)) return false;
            return dv(body) === d;
        }

        // ====== UI helpers ======
        function showSuccessThenRedirect() {
            $('#modalSuccess').modal({ backdrop: 'static', keyboard: false });
            $('#modalSuccess').modal('show');
            setTimeout(() => { window.location.href = '/empleados'; }, 2000);
        }
        function showError(detail) {
            console.error('[ERROR GUARDAR]', detail);
            $('#modalErrorDetail').text(typeof detail === 'string' ? detail : JSON.stringify(detail, null, 2));
            $('#modalError').modal({ backdrop: 'static', keyboard: true });
            $('#modalError').modal('show');
        }

        // ====== Validación en cliente ======
        function validateClient() {
            const rut  = $('#rut').val();
            const nombre = $('#nombre').val().trim();
            const email  = $('#email').val().trim();
            const rol    = $('#rol').val();
            const pass   = $('#password').val();
            const conf   = $('#confirmPassword').val();

            if (!rut) return 'El RUT es obligatorio';
            if (!isRutAcceptable(rut)) return 'El RUT no es válido';

            if (!nombre) return 'El nombre es obligatorio';

            if (!email) return 'El correo es obligatorio';
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!re.test(email)) return 'El correo no es válido';

            if (!rol) return 'Debes seleccionar un rol';

            if (!isEdit) {
                if (!pass || pass.length < 6) return 'La contraseña debe tener al menos 6 caracteres';
                if (pass !== conf) return 'Las contraseñas no coinciden';
            } else {
                if (pass && pass.length < 6) return 'La nueva contraseña debe tener al menos 6 caracteres';
                if (pass && pass !== conf) return 'Las contraseñas no coinciden';
            }
            return null;
        }

        // ====== Submit AJAX ======
        $form.on('submit', function (ev) {
            ev.preventDefault();

            const err = validateClient();
            if (err) { showError(err); return; }

            const token  = $('meta[name="_csrf"]').attr('content');
            const header = $('meta[name="_csrf_header"]').attr('content');

            const formData = new FormData(this);
            formData.set('rut', cleanRut($('#rut').val())); // guardar RUT sin puntos/guion

            $btn.prop('disabled', true).addClass('disabled');

            fetch(actionUrl, {
                method: 'POST',
                body: formData,
                headers: Object.assign(
                    { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                    header ? { [header]: token } : {}
                ),
                redirect: 'follow'
            })
                .then(async (res) => {
                    const ct = res.headers.get('content-type') || '';
                    // Esperamos JSON desde el backend para AJAX
                    if (!ct.includes('application/json')) {
                        const txt = await res.text().catch(() => '');
                        if (res.ok && /<html/i.test(txt)) {
                            // Fallback: si vino una página, asumimos éxito y redirigimos
                            showSuccessThenRedirect();
                            return;
                        }
                        throw new Error(txt || `HTTP ${res.status}`);
                    }
                    const payload = await res.json().catch(() => ({}));
                    if (!res.ok) throw new Error(payload.error || `HTTP ${res.status}`);

                    if (payload && payload.ok === true) {
                        showSuccessThenRedirect();
                    } else {
                        throw new Error(payload && payload.error ? payload.error : 'Respuesta desconocida del servidor');
                    }
                })
                .catch((e) => {
                    showError(e && e.message ? e.message : e);
                })
                .finally(() => {
                    $btn.prop('disabled', false).removeClass('disabled');
                });
        });
    })();
</script>


</body>
</html>
